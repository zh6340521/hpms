<#--
        * description: 配置值跳转界面
        * author:fuchun.hu@hand-china.com
        * version: 1.0
        *
        -->
    <#include "../include/header.html">
     <body>
     <!--定义数据源columnStyleData-->
     <script src="${base.contextPath}/common/code?columnStyleData=HPMS_COL_TYPE" type="text/javascript"></script>

     <!--***********************form表单*****************-->
     <div>
         <script type="text/javascript">

             var configValueId = '${RequestParameters.configValueId!0}';
             var companyId = '${RequestParameters.companyId!0}';
             var modelId = '${RequestParameters.modelId!0}';
             var configId = '${RequestParameters.configId!0}';


             var viewModel = kendo.observable({
                 model: {},
                 /*--新增--*/
                 createFunction:function(e){
                     $('#grid').data('kendoGrid').addRow();
                 },
             })

             //根据前界面传入的version进行查询
             $.ajax({
                 //url:'${base.contextPath}/bs/configvalue/query?configValueId='+configValueId+'&configId='+configId,
                 url:'${base.contextPath}/bs/configvalue/queryByCache?configValueId='+configValueId+'&configId='+configId,

                 //将查询出的json数据set到viewmodel的model中
                 success: function (args) {
                     var a0 = args.rows[0] || {};
                     for (var k in a0) {
                         viewModel.model.set(k, a0[k]);
                     }
                 }
             });




         </script>

         <!--bootstrap标识-->
         <div id="content-container">
             <div id="page-content">
                 <div class="panel" style="padding: 0px;">
                     <form class="form-horizontal" id="lovForm">
                         <div class="panel-body">
                             <!--将基数为12的分成三段，每段有两列，长度分别为6,6-->

                             <!--第一段-->
                             <div class="col-sm-4">
                                 <div class="row">
                                     <div class="form-group required-input">
                                         <!--<label class="col-sm-5 control-label">编码</label>-->
                                         <label class="col-sm-5 control-label"><@spring.message "hpms.mdm.calculaterule.rulecode"/></label>
                                         <div class="col-sm-7">
                                             <input name="configValueNumber" id="configValueNumber" type="text" style="width: 100%; background-color:#DDDDDD" disabled="disabled" data-bind="value:model.configValueNumber"
                                                    class="k-textbox" required>
                                             <script>kendo.bind($('#configValueNumber'), viewModel);</script>
                                         </div>
                                     </div>
                                 </div>

                             </div>

                             <!--第二段-->
                             <div class="col-sm-4">
                                 <div class="row">
                                     <div class="form-group required-input">
                                        <!-- <label class="col-sm-5 control-label">类型名称</label>-->
                                         <label class="col-sm-5 control-label"><@spring.message "hpms.mdm.equipmenttype.typename"/></label>
                                         <div class="col-sm-7">
                                             <input name="configValueName" id="configValueName" type="text" style="width: 100%; background-color:#DDDDDD" disabled="disabled" data-bind="value:model.configValueName"
                                                    class="k-textbox" required>
                                             <script>kendo.bind($('#configValueName'), viewModel);</script>
                                         </div>
                                     </div>
                                 </div>

                             </div>

                         </div>
                     </form>
                 </div>
             </div>
         </div>
         <script>
             kendo.bind($('#page-content'), viewModel);
         </script>
         <div id="createWin"></div>
     </div>

     <!--*****************我是grid分割线************************-->
     <div class="col-sm-12" style="margin-top: 10px;">
         <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
             <!--新增-->
             <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" data-bind="click:createFunction"><i class="fa fa-plus-square" style="margin-right:3px;"></i><@spring.message "hap.new"/></span>
         </div>

         <!--将按钮绑定到viewmodel上-->
         <script>kendo.bind($('#toolbar-btn'), viewModel);</script>


         <div class="panel" style="padding: 0px;border:none;box-shadow: none;">
             <div style="clear:both">
                 <div id="grid"></div>
             </div>

         </div>

     </div>


     <script>
         var crudServiceBaseUrl = "${base.contextPath}/bs/configcolumn",
                 dataSource = new kendo.data.DataSource({
                     transport: {
                         read:  {
                             //将头表id传入后台
                             url: crudServiceBaseUrl + "/query?configValueId=${RequestParameters.configValueId!0}",
                             type : "POST",
                             dataType: "json"
                         },
                         create : {
                             url : crudServiceBaseUrl + "/submit",
                             contentType: "application/json",
                             type : "POST",

                         },
                         update : {
                             url : crudServiceBaseUrl + "/submit",
                             contentType: "application/json",
                             type : "POST",
                         },
                         destroy: {
                             url: crudServiceBaseUrl + "/remove",
                             contentType: "application/json",
                             type: "POST"
                         },
                         parameterMap: function(options, type) {
                             if (type !== "read" && options.models) {
                                 //判断状态
                                 var datas = Hap.prepareSubmitParameter(options, type);
                                 //将前端的头id赋给子对象
                                 for (var i=0;i<datas.length;i++) {
                                     datas[i].configValueId = configValueId;
                                     datas[i].companyId = companyId;
                                 }
                                 //从一个对象解析出字符串
                                 return kendo.stringify(datas);
                             } else if (type === "read") {
                                 return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                             }
                         }
                     },
                     batch: true,

                     serverPaging : true,//是否在服务器端分页
                     pageSize: 10,
                     schema: {
                         data:'rows',
                         total:'total',
                         model: {
                             id: "configColumnId",   //标记信息状态的属性，不然没法根据状态判断是add还是update
                             fields: {
                                 //是否必输
                                 requiredFlag:{defaultValue: 'N',type: 'boolean',checkedValue:'Y',uncheckedValue:'N'},
                                //是否启用
                                 enableFlag:{defaultValue: 'N',type: 'boolean',checkedValue:'Y',uncheckedValue:'N'},

                             },
                            /* editable: function(col) {
                                 if(col=='columnId'||col=='columnType'){
                                     return false;
                                 }

                                 return true;
                             }*/

                         }
                     }
                 });

         var grid = $("#grid").kendoGrid({
             dataSource : dataSource,
             navigatable: false,
             height: '100%',
             resizable: true,
             scrollable: true,
             editable: "inline",
             columnMenu: true,

             pageable: {
                 pageSizes: [5, 10, 20, 50],
                 refresh: true,
                 buttonCount: 5
             },
             columns: [
                 {

                     command	: [{
                         name : "edit",
                       //  text :'编辑'
                         text :'<@spring.message "hap.edit"/>'

                     },{
                         name:"delete",
                         text:"<span class='fa fa-trash-o'></span>",
                     }],
                     attributes: {style: "text-align:center"},
                    // title		: "操作",
                     title:'<@spring.message "hap.action"/>',
                     width		: '120px' ,
                     headerAttributes: {
                         style: "text-align: center"
                     },

                 },
                 {
                     field: "columnName",
                     //name:"meaning",
                     //title: '字段名',
                     title:'<@spring.message "hpms.bs.column_name"/>',
                     width: '120px' ,
                     attributes: {style: "text-align:center"},
                     editor: function(container, options) {
                         var editor=$('<input required validationMessage="<@spring.message "hpms.notempty"/>"  name="' + options.field + '"/>')
                                 .appendTo(container)
                                 .kendoLov({
                                     //三个必须参数：code、contextPath、locale，其他参数    根据实际情况自行设置
                                     code:"LOV_BS_COLUMN_NAME",
                                     contextPath:'${base.contextPath}',
                                     locale:'${base.locale}',

                                     //传递查询参数
                                     query:function (e) {
                                         if (!e.param.modelId) {
                                             e.param.modelId = modelId;
                                         }
                                     },
                                     //拖一带三
                                     select:function(e){
                                         options.model.set("columnType",e.item.columnType);
                                         options.model.set("columnLength",e.item.columnLength);
                                         options.model.set("columnName",e.item.columnName);
                                         options.model.set("columnNameAlias",e.item.columnNameAlias);
                                         options.model.set("columnId",tranform(e.item.columnName));



                                     },
                                     //清除时也删除
                                     change : function(e){
                                         if(this.value()==""||this.value()==null){
                                             options.model.set('columnLength',null);
                                             options.model.set('columnId',null);
                                             options.model.set('columnType',null);
                                             options.model.set('columnNameAlias',null);
                                         }



                                     },



                                     textField: 'columnName',
                                     model: options.model
                                 });

                         editor.css('width','100%');
                         container.append(editor);


                     }

                 },
                 {
                     field: "columnId",
                     attributes: {style: "text-align:center"},
                     title:'组件名',
                     width: '120px',
                     editor: function(container, options){
                             var editor = $('<input id="columnId" class="k-input k-textbox k-valid"  disabled="disabled"  type="text" name="columnId"/>');
                             editor.css('width','100%');
                             container.append(editor);


                     }
                 },
                 {
                     field: "columnType",
                     attributes: {style: "text-align:center"},
                     //title: '字段类型',
                     title:'<@spring.message "lovitem.field_type"/>',
                     width: '120px',
                     editor: function(container, options){
                         var editor = $('<input id="columnType" class="k-input k-textbox k-valid" disabled="disabled" type="text" name="columnType"/>');
                         editor.css('width','100%');
                         container.append(editor);
                     }
                 },
                 {
                     field: "columnLength",
                     //title: '长度',
                     title:'<@spring.message "hpms.bs.column_length"/>',
                     width: '120px' ,
                     attributes: {style: "text-align:center"},
                     editor: function(container, options){
                         var editor = $('<input id="columnLength" class="k-input k-textbox k-valid" type="text" name="columnLength"/>');
                         editor.css('width','100%');
                         container.append(editor);
                     }
                 },
                 {
                     field: "columnNameAlias",
                     //name:"meaning",
                     //title: '别名',
                     title:'<@spring.message "hpms.bs.column_alias"/>',
                     width: '120px' ,
                     attributes: {style: "text-align:center"},
                     editor: function (container, options) {
                         var editor = $('<input id="columnNameAlias" class="k-input k-textbox k-valid" type="text" name="columnNameAlias"/>');
                         editor.css('width','100%');
                         container.append(editor);
                     },

                 },
                 {
                     field: "displayLineNo",
                     //name:"meaning",
                     title:'字符行号',
                     width: '120px' ,
                     attributes: {style: "text-align:center"},
                     editor: function (container, options) {
                         var editor = $('<input id="displayLineNo" required validationMessage="<@spring.message "hpms.notempty"/>" class="k-input k-textbox k-valid" type="text" name="displayLineNo"/>');
                         editor.css('width','100%');
                         container.append(editor);
                     },


                 },
                 {
                     field: "columnStyle",
                     attributes: {style: "text-align:center"},
                   //  title: '字符样式',
                     title:'<@spring.message "hpms.bs.column_style"/>',
                     width: '120px',
                     template: function(dataItem){//模板函数，相当于文本框渲染
                         //将field的数据和下拉框内的数据进行绑定
                         var v = dataItem.columnStyle;

                         //studentSsexData定义好的一个数据源，想当于dataSource，进行遍历
                         $.each(columnStyleData,function(i,n){
                             if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                                 v = n.meaning;
                                 return v;
                             }
                         })
                         return v;
                     },

                     editor: function(container, options){
                         //编辑时出现下拉框,options.field就是当前选中的field
                         $('<input id="columnStyle" required validationMessage="<@spring.message "hpms.notempty"/>" name="' + options.field + '"/>')
                                 .appendTo(container)
                                 .kendoDropDownList({
                                     //定义下拉框，下拉框studentStatusData其实也是json字符串，同样是key-value，
                                     // dataValueField放置key，dataTextField放置显示的value
                                     dataTextField: "meaning",
                                     dataValueField: "value",
                                     dataSource: columnStyleData,
                                     valuePrimitive: true,//如果不是true的话，选中内容会是一个object 并不是一个简单的json字符串、
                                     //拖一带三
                                     select:function(e){
                                         var columnstyle = e.sender.dataItem(e.item)[e.sender.options.dataValueField];
                                         //当选择的字符类型不为LIST时，sqlId，code和级联都为不可编辑
                                         if(columnstyle!="LIST"){

                                             $("#sysCode").attr("disabled",true);
                                             $("#sqlId").attr("disabled",true);
                                             $("#cascadeFrom").attr("disabled",true);
                                             $("#dataTextField").attr("disabled",true);
                                             $("#dataValueField").attr("disabled",true);

                                             //将文本框内的值赋空
                                             document.getElementById("sysCode").value = "";
                                             document.getElementById("sqlId").value = "";
                                             document.getElementById("cascadeFrom").value = "";
                                             document.getElementById("dataTextField").value = "";
                                             document.getElementById("dataValueField").value = "";

                                             options.model.set('sysCode',null);
                                             options.model.set('sqlId',null);
                                             options.model.set('cascadeFrom',null);
                                             options.model.set('dataTextField',null);
                                             options.model.set('dataValueField',null);

                                         }else{

                                             $("#sysCode").attr("disabled",false);
                                             $("#sqlId").attr("disabled",false);
                                             $("#cascadeFrom").attr("disabled",false);
                                             $("#dataTextField").attr("disabled",false);
                                             $("#dataValueField").attr("disabled",false);

                                             document.getElementById("sysCode").value = "";
                                             document.getElementById("sqlId").value = "";
                                             document.getElementById("cascadeFrom").value = "";
                                             document.getElementById("dataTextField").value = "";
                                             document.getElementById("dataValueField").value = "";

                                             options.model.set('sysCode',null);
                                             options.model.set('sqlId',null);
                                             options.model.set('cascadeFrom',null);
                                             options.model.set('dataTextField',null);
                                             options.model.set('dataValueField',null);

                                         }

                                     },
                                 });


                     },

                 },
                 {
                     field: "sqlId",
                     width: '120px',
                     title: '<@spring.message "lov.sqlid"/>',
                     attributes: {style: "text-align:center"},
                     editor: function (container, options) {

                         //如果字符类型为list并且快码code不为空，可编辑
                             var editor =  $('<input type="text" onclick="validatesqlid()" id="sqlId" onblur="validatesqlId(this)"  />').appendTo(container).kendoMaskedTextBox({});
                             editor.css('width','100%');
                             container.append(editor);
                     }
                 },
                 {
                     field: "dataTextField",
                     width: '120px',
                     title: '显示字段',
                     attributes: {style: "text-align:center"},
                     editor: function (container, options) {

                         //如果字符类型为list并且快码code不为空，可编辑
                         var editor =  $('<input type="text" id="dataTextField"    />').appendTo(container).kendoMaskedTextBox({});
                         editor.css('width','100%');
                         container.append(editor);
                     }
                 },
                 {
                     field: "dataValueField",
                     width: '120px',
                     title: '实际字段',
                     attributes: {style: "text-align:center"},
                     editor: function (container, options) {

                         //如果字符类型为list并且快码code不为空，可编辑
                         var editor =  $('<input type="text" id="dataValueField"  />').appendTo(container).kendoMaskedTextBox({});
                         editor.css('width','100%');
                         container.append(editor);
                     }
                 },
                 {
                     field: "sysCode",
                     width: '120px',
                     title: '快码CODE',
                     attributes: {style: "text-align:center"},
                     editor: function (container, options) {
                             var editor = $('<input id="sysCode" onclick="validateself()" onblur="validateSysCode(this)" class="k-input k-textbox k-valid" type="text" name="' + options.field + '"/>');
                             editor.css('width','100%');
                             container.append(editor);

                     }
                 },
                 {
                     field: "cascadeFrom",
                     width: '120px',
                     title: '级联组件名',
                     attributes: {style: "text-align:center"},
                     editor: function (container, options) {


                             var editor = $('<input id="cascadeFrom" onblur="validateCascadeFrom(this)"   class="k-input k-textbox k-valid" type="text" name="' + options.field + '"/>');
                             editor.css('width','100%');
                             container.append(editor);

                     }
                 },
                 {
                     field: "requiredFlag",
                     width: '120px',
                     title: '<@spring.message "hpms.bs.column_requireflag"/>',
                     attributes: {style: "text-align:center"}
                 },
                 {
                     field: "enableFlag",
                     width: '120px',
                    // title: '是否启用',
                     title:'<@spring.message "hap.enableflag"/>',
                     attributes: {style: "text-align:center"}
                 }

             ],


         }).data("kendoGrid");


         //自动调整
         Hap.autoResizeGrid("#grid");
         //设置表格上的字居中
         $("#grid thead>tr th").css("text-align","center");


         //将大写字符串转成驼峰命名法
         function tranform(str){
             var s = str;
             s = s.toLowerCase();
             var a = s.split("_");
             var o = a[0];
             for(var i=1;i<a.length;i++){
                 o = o + a[i].slice(0,1).toUpperCase() + a[i].slice(1);
             }
             return o;
         }

         //触发文本框事件  触发code时，当sqlId不为空则不可编辑
         function validateself(){
             var sqlId = $("#sqlId").val();
             if(sqlId==null||sqlId==""){
                 $("#sysCode").attr("disabled",false);
             }else{
                 $("#sysCode").attr("disabled",true);
             }
         }

         //触发sqlid事件  当未选择字符类型时，sqlid等不可编辑
         function validatesqlid(){
             var columnStyle = $("#columnStyle").val();

             if(columnStyle==null||columnStyle==""){
                 $("#sysCode").attr("disabled",true);
                 $("#sqlId").attr("disabled",true);
                 $("#cascadeFrom").attr("disabled",true);
                 $("#dataTextField").attr("disabled",true);
                 $("#dataValueField").attr("disabled",true);
             }



         }

         //校验sqlId  当sqlId不为空时，可以填code,反之 不可以
         function validatesqlId(self){
            /* var dataTextField = $("#dataTextField").val();
             var dataValueField = $("#dataValueField").val();
             var sqlId = $("#sqlId").val();
             if((dataTextField==""||dataTextField==null||dataValueField==""||dataValueField=="")&&(sqlId!=null||sqlId!="")){
                 kendo.ui.showErrorDialog({
                     message: "请输入对应的字段名"
                 })
             }*/

             if(self.value!=null&&self.value!=""){

                 $("#sysCode").attr("disabled",true);
                 $("#dataTextField").attr("disabled",false);
                 $("#dataValueField").attr("disabled",false);
             }else{
                 $("#dataTextField").attr("disabled",true);
                 $("#dataValueField").attr("disabled",true);
                 $("#sysCode").attr("disabled",false);
             }
         }

         //校验code 当code为空时，可以填sqlId,反之 不可以
         function validateSysCode(self){

             //判断此时sqlid是否为空,为空则可编辑
             var sqlId = $("#sqlId").val();
             if(sqlId==null||sqlId==""){
                 $("#sysCode").attr("disabled",false);
             }else{
                 $("#sysCode").attr("disabled",true);
             }

            if(self.value!=null&&self.value!=""){
                $("#sqlId").attr("disabled",true);
                $("#cascadeFrom").attr("disabled",true);

                //当code不为空时，显示字段等不可编辑
                $("#dataTextField").attr("disabled",true);
                $("#dataValueField").attr("disabled",true);
            }else{
                $("#sqlId").attr("disabled",false);
                $("#cascadeFrom").attr("disabled",false);

                $("#dataTextField").attr("disabled",false);
                $("#dataValueField").attr("disabled",false);
            }
         }

         //校验级联 当输入了级联的组件后，如果sqlId为空，弹出提示sqlId为必输，反之 没提示
         function validateCascadeFrom(self)
         {
             var dataTextField = $("#dataTextField").val();
             var dataValueField = $("#dataValueField").val();
             var sqlId = $("#sqlId").val();

             /*if((dataTextField==""||dataTextField==null||dataValueField==""||dataValueField=="")&&(sqlId!=null&&sqlId!="")){
                 kendo.ui.showErrorDialog({
                     message: "请输入对应的字段名"
                 })
             }*/


             if(sqlId==null||sqlId==""){
                 if(self.value!=null&&self.value!=""){
                     kendo.ui.showErrorDialog({
                         message: "请输入对应的sqlId"
                     })
                 }
             }

             //如果级联不为空，code不可编辑
             if(self.value!=null&&self.value!=""){
                 $("#sysCode").attr("disabled",true);
             }else{
                 $("#sysCode").attr("disabled",false);
             }

         }

     </script>



     </body>