<#include "../include/header.html">
    <body>
    <script src="${base.contextPath}/common/code?resourceTypeData=HPMS_DATE_TYPE" type="text/javascript"></script>
    <script type="text/javascript">
        // 初始化viewModel
        var viewModel = kendo.observable({
            model: {},
            // 将快码的值设为全局变量
            typeResource: resourceTypeData,
            // 条件查询
            queryResource: function (e) {
                $("#grid").data("kendoGrid").dataSource.page(1);
            },
            // 新增函数
            createFunction: function(){
                $('#grid').data('kendoGrid').addRow();
            },
            // 重置查询框
            resetForm: function (e) {
                var formDate = viewModel.model.toJSON();
                for (var k in formDate) {
                    viewModel.model.set(k, null);
                }
                $("#grid").data("kendoGrid").dataSource.page(1);
            },
        });

        // 获取当前使用编号
        var currentNum = ${RequestParameters.currentNum!0};

    </script>
    <div id="page-content">
        <div class="panel" style="padding: 0px;border:none;box-shadow: none;">
            <form class="form-horizontal" id="query-form" style="margin-top: 1px;">
                <div class="panel-body">
                    <div class="row" style="margin-bottom: 5px;">
                        <!-- 编码 -->
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">编码</label>
                                <div class="col-sm-8">
                                    <input type="text" style="width: 160px"
                                           data-bind="value:model.sequenceCode"
                                           class="k-textbox">
                                </div>
                            </div>
                        </div>
                        <!-- 编码名称 -->
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">编码名称</label>
                                <div class="col-sm-8">
                                    <input type="text" style="width: 160px"
                                           data-bind="value:model.sequenceName"
                                           class="k-textbox">
                                </div>
                            </div>
                        </div>
                        <!-- 查询框按钮 -->
                        <div style="float:right;">
                            <span class="btn btn-primary" style="width: 70px;float:left;margin-right:5px;" data-bind="click:queryResource"
                                  type="submit"><@spring.message "hap.query"/></span>
                            <span class="btn btn-default" style="float:left;width:70px" data-bind="click:resetForm"
                                  type="button"><@spring.message "hap.reset"/></span>
                        </div>
                        <div style="clear:both"></div>
                    </div>
                </div>
            </form>
        </div>
        <!-- gird组件 -->
        <div style="clear: both;">
            <div id="grid"></div>
        </div>
    </div>
    <script>
        // 绑定查询框
        kendo.bind($('#query-form'), viewModel);
        // 查询框按键
        $("#query-form").keydown(function (e) {
            if (e.keyCode == 13) {
                e.target.blur();
                viewModel.queryResource(e);
            }
        });
        // 当前路径
        var crudServiceBaseUrl = '${base.contextPath}/bs/seq';
        // 定义数据源
        var dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: crudServiceBaseUrl + "/query",
                    type: "GET",
                    dataType: "json"
                },
                create: {
                    url: crudServiceBaseUrl + "/create",
                    contentType: "application/json",
                    type: "POST"
                },
                update: {
                    url: crudServiceBaseUrl + "/update",
                    contentType: "application/json",
                    type: "POST"
                },
                destroy: {
                    url: crudServiceBaseUrl + "/delete",
                    contentType: "application/json",
                    type: "DELETE"
                },
                parameterMap: function (options, type) {
                    if (type !== "read" && options.models) {
                        var datas = Hap.prepareSubmitParameter(options, type);
                        return kendo.stringify(datas);
                    } else if (type === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                    }
                },
            },
            requestEnd: function (e) {
                if(e.type=='create'&&e.response.success==true){
                    kendo.ui.showInfoDialog({
                        message: '添加成功!'
                    });
                    $('#grid').data('kendoGrid').dataSource.read();
                } else if(e.type=='update'&&e.response.success==true){
                    kendo.ui.showInfoDialog({
                        message: '更新成功!'
                    });
                }else if(e.type !='read'){
                    $('#grid').data('kendoGrid').dataSource.read();
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "sequenceId",
                    fields: {
                        companyFlag:{
                            defaultValue: 'N',
                            type: 'boolean',
                            checkedValue: 'Y',
                            uncheckedValue: 'N'},
                        projectFlag:{
                            defaultValue: 'Y',
                            type: 'boolean',
                            checkedValue: 'Y',
                            uncheckedValue: 'N',
                            editable: false
                        },
                        currentNum:{
                            defaultValue:currentNum,
                        },
                        startDateActive:{type:"date"},
                        endDateActive:{type:"date",defaultValue:''},
                    },
                }
            }
        });
        var grid = $('#grid').kendoGrid({
            dataSource: dataSource,
            height: '100%',
            resizable: false,
            scrollable: true,
            selectable: 'row',
            editable: "inline",
            sortable: true,
            navigatable: false,
            reorderable: true,
            toolbar:[
                {template:('<span onclick="viewModel.createFunction()" class="btn btn-info" style="float:left;margin-right:5px;">新增</span>')},
            ],
            pageable: {
                // 分页类别
                pageSizes: [5, 10, 20, 50],
                // 刷新按钮
                refresh: true,
                // 最大显示页面数
                buttonCount: 5
            },
            columns: [
                {
                    title:'操作',
                    attributes: {style: "text-align:center"},
                    command:[ {
                        name: "edit",
                        isEnable: function (data) {
                         if(data.endDateActive != null){
                                  return false;
                          }
                                  return true;
                         }
                    },
                    ],
                    width:'12%'
                },
/*                {
                    title:'操作',
                    attributes: {style: "text-align:center"},
                    width: '6%',
                    template:function (rowdata){
                        if(rowdata.endDateActive == null){
                            return '<a type="button" class="k-button k-button-icontext k-grid-edit">' +
                                '<span class="fa fa-pencil-square-o"></span></a>'
                        }else{
                            return '<a type="button" class="k-button k-button-icontext k-grid-edit" disable>' +
                                '<span class="fa fa-pencil-square-o"></span></a>'
                        }
                    },
                    editor:function (container, options) {
//                            $('<a href="#">asdas</a> ').appendTo(container)
                        container.innerHTML= "<a href='#'>asdas</a>"
                    }
                },*/
                {
                    field: "sequenceCode",
                    title: '编码',
                    width: '12%',
                    attributes: {style: "text-align:center"},
                    editor: function (container, options) {
                        if(options.model.sequenceId == null || options.model.sequenceId==""){
                            $('<input  required type="text" class="k-textbox" validationMessage="大写,数字和_" pattern="^[A-Z0-9_]+$" name="' + options.field + '"/>').appendTo(container)
                        }else{
                            $('<span>'+options.model.sequenceCode+'</span>')
                                .appendTo(container)
                        }
                    },
                },
                {
                    field: "sequenceName",
                    title: '编码名称',
                    width: '12%',
                    attributes: {style: "text-align:center"},
                    editor: function (container, options) {
                        if(options.model.sequenceId == null || options.model.sequenceId==""){
                            $('<input  required type="text" class="k-textbox" validationMessage="必填" name="' + options.field + '"/>').appendTo(container)
                        }else{
                            $('<span>'+options.model.sequenceName+'</span>')
                                .appendTo(container)
                        }
                    },
                },
                {
                    field: "companyFlag",
                    title: '公司',
                    attributes: {style: "text-align:center"},
                    width: '6%',
                    editor: function (container, options) {
                        if(options.model.sequenceId == null || options.model.sequenceId==""){
                            $('<span tabindex="0" class="k-checkbox k-state-default fa fa-check"><input type="checkbox" name="companyFlag" data-type="boolean" data-bind="checked:companyFlag" data-role="checkbox" value="'+options.model.companyFlag+'" style="display: none;" class="k-valid"></span>').appendTo(container)
                        }else{
                            $('<span tabindex="0" class="k-checkbox k-state-default fa fa-check"><input readonly type="checkbox" name="companyFlag" data-type="boolean" data-bind="checked:companyFlag" data-role="checkbox" value="'+options.model.companyFlag+'" style="display: none;" class="k-valid"></span>').appendTo(container)
                         }
                    },


                },
                {
                    field: "projectFlag",
                    title: '项目',
                    attributes: {style: "text-align:center"},
                    width: '6%',
                },
                {
                    field: "prefix",
                    title: '前缀',
                    width: '10%',
                    attributes: {style: "text-align:center"},
                    editor: function (container, options) {
                        if(options.model.sequenceId == null || options.model.sequenceId==""){
                            $('<input required type="text" class="k-textbox" validationMessage="大写和数字" pattern="^[A-Z0-9]+$" name="' + options.field + '"/>').appendTo(container)
                        }else{
                            $('<span>'+options.model.sequenceName+'</span>')
                                .appendTo(container)
                        }
                    },
                },
                {
                    field: "dateFormat",
                    title: '日期格式',
                    width: '12%',
                    attributes: {style: "text-align:center"},
                    editor: function (container, options) {
                        if(options.model.sequenceId == null || options.model.sequenceId==""){
                            $('<input required validationMessage="必输" name="' + options.field + '"/>')
                                .appendTo(container)
                                .kendoDropDownList({
                                    dataTextField: "meaning",
                                    dataValueField:"lookupCode",
//                                 选择的实际值       dataValueField: "value",
                                    valuePrimitive: true,
                                    dataSource: resourceTypeData,
                                    index:-1,
                                });
                        }else{
                            $('<span>'+options.model.dateFormat+'</span>')
                                .appendTo(container)
                        }
                    }
                },
                {
                    field: "figure",
                    title: '流水号位数',
                    width: '10%',
                    attributes: {style: "text-align:center"},
                    editor: function (container, options) {
                        if(options.model.sequenceId == null || options.model.sequenceId==""){
                            $('<input required type="text" class="k-textbox" validationMessage="非负整数" pattern="^[0-9]+$" name="' + options.field + '"/>').appendTo(container)
                        }else{
                            $('<span>'+options.model.figure+'</span>')
                                .appendTo(container)
                        }
                    },
                },
                {
                    field: 'startNum',
                    title: '起始编号',
                    width: '10%',
                    attributes: {style: "text-align:center"},
                    editor: function (container, options) {
                        if(options.model.sequenceId == null || options.model.sequenceId==""){
                            $('<input required type="text" class="k-textbox" validationMessage="非负整数" pattern="^[0-9]+$" name="' + options.field + '"/>').appendTo(container)
                        }else{
                            $('<span>'+options.model.startNum+'</span>')
                                .appendTo(container)
                        }
                    },
                },
                {
                    field: 'currentNum',
                    title: '当前使用编号',
                    width: '12%',
                    attributes: {style: "text-align:center"},
                    editor:function (container, options) {
                        $('<span>'+currentNum+'</span>')
                            .appendTo(container)
                    }
                },
                {
                    field:"startDateActive",
                    title: "有效期起",
                    format: "{0:yyyy/MM/dd}",
                    width: '16%',
                    attributes: {style: "text-align:center"},
                    template:function (rowdata){
                        if(rowdata.dateFormat =='YYYY'){
                            return kendo.toString(rowdata.startDateActive,"yyyy");
                        }else if(rowdata.dateFormat == 'YYYYMM'){
                            return kendo.toString(rowdata.startDateActive,"yyyy/MM");
                        }else{
                            return kendo.toString(rowdata.startDateActive,"yyyy/MM/dd");
                        }
                    },
                    editor: function (container, options){
                        if(options.model.sequenceId == null || options.model.sequenceId==""){
                            $('<input id="startDateActive" name="' + options.field + '"/>')
                                .appendTo(container)
                                .kendoDatePicker({
                                    format: "yyyy/MM/dd",
                                    change: function () {
                                        if (this.value() != null) {
                                            d = this.value();
                                        } else {
                                            d = new Date(1900, 0, 1, 22, 0, 0);
                                        }
                                        $('#endDateActive').val( kendo.toString(d, "yyyy/MM/dd"));
                                        $('#endDateActive').data('kendoDatePicker').min(d)
                                    }
                                });
                        }else{
                            $('<span>'+kendo.toString(options.model.startDateActive, "yyyy/MM/dd")+'</span>')
                                .appendTo(container)
                        }
                    }
                },
                {
                    field:"endDateActive",
                    title: "有效期至",
                    format: "{0:yyyy/MM/dd}",
                    width: '16%',
                    attributes: {style: "text-align:center"},
                    template:function (rowdata){
                        if(rowdata.endDateActive == null){
                            return ""
                        }
                        else if(rowdata.dateFormat =='YYYY'){
                            return kendo.toString(rowdata.endDateActive,"yyyy");
                        }else if(rowdata.dateFormat == 'YYYYMM'){
                            return kendo.toString(rowdata.endDateActive,"yyyy/MM");
                        }else{
                            return kendo.toString(rowdata.endDateActive,"yyyy/MM/dd");
                        }
                    },
                    editor: function (container, options) {
                        var start = options.model.startDateActive;
                        var d;
                        if (start) {
                            d = start;
                        }
                        $('<input id="endDateActive" name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoDatePicker({
                                format: "yyyy/MM/dd",
                                min: d,
                                change: function () {
                                    if (this.value() != null) {
                                        d = this.value();
                                    } else {
                                        d = new Date(2099, 0, 1, 22, 0, 0);
                                    }
                                    $('#startDateActive').data('kendoDatePicker').max(d)
                                }
                            });
                    }
                }
            ],
        }).data("kendoGrid");
        // 自动填充界面
        Hap.autoResizeGrid("#grid");
        // 标题居中
        $("#grid thead>tr th").css("text-align", "center");
    </script>
    </body>