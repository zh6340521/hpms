<#include "../include/header.html">
    <script type="text/javascript">
        var companyId= <#if RequestParameters.companyId?exists>
        ${RequestParameters.companyId}
        <#else>-1</#if>;

        var projectId= <#if RequestParameters.projectId?exists>
        ${RequestParameters.projectId}
        <#else>-1</#if>;

        var equipmentTypeId= <#if RequestParameters.equipmentTypeId?exists>
        ${RequestParameters.equipmentTypeId}
        <#else>-1</#if>;

        var propertyId= <#if RequestParameters.propertyId?exists>
        ${RequestParameters.propertyId}
        <#else>-1</#if>;



        var viewModel = kendo.observable({
            model: {},
            queryResource: function (e) {
                $('#Grid').data('kendoGrid').dataSource.page(1);
            }
        });
    </script>
    <body>
    <div id="page-content">
        <div id="property_bind_form">
            <form class="form-horizontal" style="margin-right:10%;">

                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-xs-6 control-label" style="text-align: right"><@spring.message "hpms.mdm.equipment.equipmentCode"/></label>
                        <div class="col-xs-6">
                            <input type="text" class="k-textbox" name="equipmentCode"  data-bind="value:model.equipmentCode" style="width: 90%;">
                        </div>

                    </div>
                </div>

                <div class="col-xs-6" >
                    <div class="form-group">
                        <label class="col-xs-6 control-label" style="text-align: right"><@spring.message "hpms.mdm.equipment.equipmentName"/></label>
                        <div class="col-xs-6">
                            <input type="text" class="k-textbox" name="equipmentName"  data-bind="value:model.equipmentName" style="width: 90%;"/>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <script>kendo.bind($('#property_bind_form'), viewModel);</script>

        <div class="pull-left" id="toolbar-btn" style="clear:both;padding-bottom:10px;padding-top:20px;">
            <span   data-bind="click:queryResource" class="btn btn-primary" style="float:left;margin-right:10px;"><i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
        </div>
        <script>kendo.bind($('#toolbar-btn'), viewModel);</script>

        <div style="clear:both">
            <div id="Grid"></div>
        </div>
    </div>

    <script type="text/javascript">


        var BaseUrl = _basePath;
        dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: BaseUrl + "/hpms/fin/cusmeter/equipment/query?companyId="+companyId+"&&projectId="+projectId+"&&equipmentTypeId="+equipmentTypeId+"&&equipmentStatus="+'A',
                    type: "POST",
                    dataType: "json"
                },
                parameterMap: function (options, type) {
                    if (type !== "read" && options.models) {
                        var datas = Hap.prepareSubmitParameter(options, type)
                        return kendo.stringify(datas);
                    } else if (type === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                    }
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "cusmeterBindId",
                    fields: {}
                }
            }
        });

        $("#Grid").kendoGrid({
            dataSource : dataSource,
            navigatable: false,
            height     : '100%',
            resizable  : true,
            scrollable : true,
            //selectable : "single,rowbox",
            reorderable: true,
            sortable   : true,
            //columnMenu : true, //实现右击可以隐藏显示列
            pageable: {
                pageSizes: [5, 10, 20, 50],
                refresh: true,
                buttonCount: 5
            },
            columns: [
                {
                    field: "equipmentCode",
                    title: '<@spring.message "hpms.mdm.equipment.equipmentCode"/>',
                    width: 120

                },
                {
                    field: "equipmentName",
                    title: '<@spring.message "hpms.mdm.equipment.equipmentName"/>',
                    width: 120
                },
                {
                    field: "structureName",
                    title: "位置信息",
                    width: 120,
                    attributes: {style: "text-align:center"}
                },
                {
                    field: "meaning2",
                    title: '<@spring.message "hpms.mdm.equipment.equipmentStatus"/>',
                    width: 100,
                    attributes  : {style: "text-align:center"}
                }
            ],
            editable: false
        }).data("kendoGrid");

        function deleteData() {

            Hap.deleteGridSelection({
                grid: $('#Grid')
            });

        }

        Hap.autoResizeGrid("#Grid");

        $("#Grid").on("dblclick", "tr.k-state-current", function (e) {

            var data = $("#Grid").data("kendoGrid").dataItem($(e.target).closest("tr")); //获取选中行对象
            //console.log(data.VALUE3);
            //console.log(data.equipmentId);
            var equipmentMessage = kendo.stringify(data);
            var json = JSON.parse(equipmentMessage);
            json.structureId=data.equipmentId;
            json.propertyId=propertyId;
            $.ajax({
                url: "${base.contextPath}/hpms/fin/cusmeter/bind/submit",
                type:"POST",
                dataType:"json",
                contentType:"application/json",
                data:  kendo.stringify(json),
                success: function(data){
                    if (data.success) {
                        //console.log(data.rows[0]);
                        var propertyWindow=window.parent;
                        propertyWindow.parent.$('#Grid').data('kendoGrid').dataSource.page(1);
                        window.parent.$('#Grid').data('kendoGrid').dataSource.page(1);
                        window.parent.$("#equipmentViews").data("kendoWindow").close();
                        //window.parent.$('#Grid').data('kendoGrid').dataSource.page(1);

                    }else{
                        kendo.ui.showInfoDialog({
                            message:data.message
                        })

                    }
                }});



            //queryChildrenIntfc(data.DATA_LINE_ID);
        });





    </script>
    </body>
    </html>