<#--
        * description: 收款录入界面
        * version: 1.0
        * author: feng.liu01@hand-china.com
        * #{copyright}#
        *
        -->

<#include "../include/header.html">

<script
        src="${base.contextPath}/common/code?docTypeData=HPMS_DOC_TYPE">
</script>

<style type="text/css">
    span.red {
        color: red;
        font-weight: bold;
    }
    table tr td {
        width:100px;
        height: 30px;
        text-align: center;
    }
</style>

<script type="text/javascript">

    var type = 'receivable';

    var advanceAmount = 0;

    var viewModel = kendo.observable({
        model: {
            receiptDate:Hap.formatDate(new Date())

        }
    });


    function addFee() {

        if (viewModel.model.get("companyId")==null){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.fin.receipt.selectcompany"/>'
            });
            return;
        }

        if (viewModel.model.get("projectId")==null){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.mdm.projectprocedure.error"/>'
            });
            return;
        }

        if (viewModel.model.get("customerCode")==null){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.fin.receipt.selectcustomer"/>'
            });
            return;
        }

        if (type==='collection'){
            $("#addFeeId").kendoWindow({
                actions: ["Close"],
                title: '<@spring.message "hpms.fin.receipt.addfee"/>',
                draggable: true,
                height: "300px",
                width: "1000px",
                close: function(){
                    $("#addFeeId").empty();
                },
                content: "${base.contextPath}/fin/receipt_add_agent.html",
                iframe: true,
                modal: true
            });
        }else {
            var transType = '';
            if (type==='receivable') {
                transType = 'RECEIVABLE';
            }else if (type==='deposit'){
                transType = 'DEPOSIT';
            }
            $("#addFeeId").kendoWindow({
                actions: ["Close"],
                title: '<@spring.message "hpms.fin.receipt.addfee"/>',
                draggable: true,
                height: "300px",
                width: "1000px",
                close: function(){
                    $("#addFeeId").empty();
                },
                content: "${base.contextPath}/fin/receipt_add_fee.html?transType="+transType,
                iframe: true,
                modal: true
            });
        }


        var win = $("#addFeeId").data("kendoWindow");
        win.bind("close",function () {
            $("#tabstrip").data("kendoTabStrip").select($('#all'));
        });
        win.center().open();
    }

    function receipt() {

        if (viewModel.model.get("companyId")==null){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.fin.receipt.selectcompany"/>'
            });
            return;
        }

        if (viewModel.model.get("projectId")==null){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.mdm.projectprocedure.error"/>'
            });
            return;
        }

        if (viewModel.model.get("customerCode")==null){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.fin.receipt.selectcustomer"/>'
            });
            return;
        }

        if (type==='advance'){

            viewModel.model.set("receiptStatus", "D");

        } else if (type==='receivable') {
            let gridData = $("#receivableGrid").data("kendoGrid").selectedDataItems();
            viewModel.model.set("feeLists",gridData);
            viewModel.model.set("receiptStatus", "C");
        } else if (type==='deposit') {
            let gridData = $("#depositGrid").data("kendoGrid").selectedDataItems();
            viewModel.model.set("feeLists",gridData);
            viewModel.model.set("receiptStatus", "A");
        } else if (type==='collection') {
            let gridData = $("#collectionGrid").data("kendoGrid").selectedDataItems();
            viewModel.model.set("feeLists",gridData);
            viewModel.model.set("receiptStatus", "A");
        } else if (type==='adjustment') {
            let gridData = $("#adjustmentGrid").data("kendoGrid").selectedDataItems();
            viewModel.model.set("feeLists",gridData);
            viewModel.model.set("receiptStatus", "A");
        }

        if (type!=='advance'){

            if (viewModel.model.feeLists.length==0){
                kendo.ui.showInfoDialog({
                    title: $l('hap.prompt'),
                    message: '<@spring.message "hpms.mdm.receipt.selectfeelist"/>'
                });
                return;
            }

        }



        if (viewModel.model.get("sumPrice") < viewModel.model.get("receiptAmount")){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.mdm.receipt.sumPricemin"/>'
            });
            return;
        }

        if (!viewModel.model.get("receiptAmount") || viewModel.model.get("receiptAmount")<=0){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.mdm.receipt.receiptAmountbig"/>'
            });
            return;
        }
        if (!viewModel.model.get("receiptMethod")){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.mdm.receipt.selectreceiptmethod"/>'
            });
            return;
        }
        if (!viewModel.model.get("receiptTerm")){
            kendo.ui.showInfoDialog({
                title: $l('hap.prompt'),
                message: '<@spring.message "hpms.mdm.receipt.selectreceiptterm"/>'
            });
            return;
        }

        viewModel.model.set("transactor","${Session.userName}");
        $.ajax({
            url: '${base.contextPath}/fin/receipt/submit',
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data       : JSON.stringify(viewModel.model),
            success: function (args) {
                if (args.success) {
                    kendo.ui.showInfoDialog({
                        title: $l('hap.prompt'),
                        message: $l('hap.tip.success')
                    }).done(function () {
                        $("#tabstrip").data("kendoTabStrip").select($('#all'));
                    })
                }
            }
        });


    }

    function cancelFeeList() {
        let gridData = $("#receivableGrid").data("kendoGrid").selectedDataItems();
        viewModel.model.set("feeLists",gridData);
        viewModel.model.set("operationType", "cancel");

        $.ajax({
            url: '${base.contextPath}/fin/receipt/submit',
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data       : JSON.stringify(viewModel.model),
            success: function (args) {
                if (args.success) {
                    kendo.ui.showInfoDialog({
                        title: $l('hap.prompt'),
                        message: $l('hap.tip.success')
                    }).done(function () {
                        $('#receivableGrid').data('kendoGrid').dataSource.page(1);

                    })
                }
            }
        });
    }

    function refund(receiptId) {
        $("#refundId").kendoWindow({
            actions: ["Close"],
            title: '<@spring.message "hpms.mdm.receipt.refund"/>',
            draggable: true,
            height: "450px",
            width: "800px",
            close: function(){
                $("#refundId").empty();
            },
            content: "${base.contextPath}/fin/receipt_refund.html?receiptId="+receiptId,
            iframe: true,
            modal: true
        });

        var win = $("#refundId").data("kendoWindow");
        win.center().open();
    }

</script>
<body>
<div id="addFeeId" style="display: none"></div>
<div id="refundId" style="display: none"></div>
<div id="page-content">

    <div class="panel" style="padding: 0;width: 80%;">
        <div class="panel-body">
            <table class="pull-right">
                <tr>
                    <td><@spring.message "hpms.mdm.receipt.payer"/></td>
                    <td><@spring.message "hpms.mdm.receipt.payee"/></td>
                    <td><@spring.message "hpms.mdm.receipt.copydate"/></td>
                </tr>
                <tr>
                    <td>
                        <input type="text" data-role="maskedtextbox" style="width:80px;"
                               data-bind="value:model.payer" class="k-textbox">
                    </td>
                    <td>${Session.userName}</td>
                    <td id="makeDateId"></td>
                    <script>
                        $("#makeDateId").text(Hap.formatDate(new Date()));
                    </script>
                </tr>
            </table>
        </div>
    </div>

    <div class="panel" style="padding: 0px;width: 80%;">
        <div class="form-horizontal" id="query-form">
            <div class="panel-body">
                <div class="row" style="margin-bottom: 10px;">
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.occupation.company"/>：</label>
                            <div class="col-sm-8">
                                <input id="companyId" type="text" style="float:left;width:150px;margin-right:5px;"
                                       data-bind="value:model.companyId">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.occupation.project"/>：</label>
                            <div class="col-sm-8">
                                <input id="projectId" type="text" style="float:left;width:150px;margin-right:5px;"
                                       data-bind="value:model.projectId">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.fin.feecode"/>：</label>
                            <div class="col-sm-8">
                                <input type="text" data-role="maskedtextbox" style="float:left;width:150px;margin-right:5px;"
                                       data-bind="value:model.propertyNumber" class="k-textbox" disabled>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row" style="margin-bottom: 10px;">
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.property.propertyname"/>：</label>
                            <div class="col-sm-8">
                                <input type="text" data-role="maskedtextbox" style="float:left;width:150px;margin-right:5px;"
                                       data-bind="value:model.propertyName" class="k-textbox" disabled>

                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.receipt.customercode"/>：</label>
                            <div class="col-sm-8">
                                <input type="text" data-role="maskedtextbox" style="float:left;width:150px;margin-right:5px;"
                                       data-bind="value:model.customerCode" class="k-textbox" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.customer.customername"/>：</label>
                            <div class="col-sm-8">
                                <input id="customerNameId" type="text" style="width:150px;margin-right:5px;"
                                       data-bind="value:model.customerName">
                            </div>
                        </div>
                    </div>


                </div>

                <div class="row" style="margin-bottom: 10px;">

                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.receipt.receiptDate"/>：</label>
                            <div class="col-sm-8">
                                <input id="receiptDateId" type="text" style="width:150px;margin-right:5px;"
                                       data-bind="value:model.receiptDate">
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.receipt.receiptmethod"/>：</label>
                            <div class="col-sm-8">
                                <input id="receiptMethodId" type="text" style="float:left;width:150px;margin-right:5px;"
                                       data-bind="value:model.receiptMethod">
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.receipt.receiptterm"/>：</label>
                            <div class="col-sm-8">
                                <input id="receiptTermId" type="text" style="float:left;width:150px;margin-right:5px;"
                                       data-bind="value:model.receiptTerm">
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row" style="margin-bottom: 10px;">
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.receipt.sumprice"/>：</label>
                            <div class="col-sm-8">
                                <input id="sumPriceInp" type="text" style="width:150px;margin-right:5px;"
                                       data-bind="value:model.sumPrice" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.receipt.receiptamount"/>：</label>
                            <div class="col-sm-8">
                                <input id="receiptAmountInp" type="text" style="width:150px;margin-right:5px;"
                                       data-bind="value:model.receiptAmount">
                                <script>
                                    $("#sumPriceInp").kendoNumericTextBox({});
                                    $("#receiptAmountInp").kendoNumericTextBox({
                                        min: 0,
                                        change: function () {
                                            var value = this.value();
                                            viewModel.model.set("balance", viewModel.model.sumPrice - value);
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.fin.invoice.balance"/>：</label>
                            <div class="col-sm-8">
                                <input id="balanceInp" type="text" style="width:150px;margin-right:5px;"
                                       data-bind="value:model.balance" disabled>

                            </div>
                        </div>
                    </div>


                </div>

                <div class="row" style="margin-bottom: 10px;">
                    <div class="col-sm-4" style="padding: 0">
                        <div class="form-group" style="margin: 0">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.fin.feelist.adjamount"/>：</label>
                            <div class="col-sm-8">
                                <input id="adjAmountInp" type="text" style="width:150px;margin-right:5px;"
                                       data-bind="value:model.adjAmount" disabled>

                                <script>
                                    $("#balanceInp").kendoNumericTextBox({});
                                    $("#adjAmountInp").kendoNumericTextBox({});
                                </script>
                            </div>
                        </div>
                    </div>


                </div>

            </div>
        </div>
    </div>

    <div class="pull-left" id="toolbar-btn" style="height: 30px;margin-left:200px;margin-bottom: 10px;">
        <span id="addFeeBtn" class="btn btn-primary k-grid-add"
              style="float: left; margin-right: 5px;" onclick="addFee()">
            <i class="fa fa-plus-square" style="margin-right:3px;"></i>
            <@spring.message "添加费项收款"/>
        </span>

        <span id="receiptBtn" class="btn btn-primary k-grid-add"
              style="float: left; margin-right: 5px;" onclick="receipt()">
            <i class="fa fa-pencil-square-o" style="margin-right:3px;"></i>
            <@spring.message "收款"/>
        </span>

        <span id="moveoutBtn" class="btn btn-primary k-grid-add"
              style="float: left; margin-right: 5px;" onclick="cancelFeeList()">
            <i class="fa fa-search" style="margin-right:3px;"></i>
            <@spring.message "撤销"/>
        </span>

    </div>


    <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
    <script>kendo.bind($('#query-form'), viewModel);</script>

    <div id="tabstrip" style="clear:both;">
        <ul class="nav nav-tabs">
            <li id="receivable"><@spring.message "hpms.mdm.paymentmethod.arflag"/></li>
            <li id="adjustment"><@spring.message "hpms.mdm.receipt.adjustment"/></li>
            <li id="advance"><@spring.message "hpms.mdm.receipt.advance"/></li>
            <li id="deposit"><@spring.message "hpms.mdm.receipt.deposit"/></li>
            <li id="collection"><@spring.message "hpms.mdm.receipt.collection"/></li>
            <li id="all"><@spring.message "hpms.mdm.receipt.all"/></li>
        </ul>
        <!--应收-->
        <div>
            <div id="advanceDiv" style="margin-top: 5px;">
                <input id="advanceId" type="text" style="margin-right:5px;"
                       data-bind="value:model.advanceFlag">
                <@spring.message "hpms.mdm.receipt.advancediv1"/>
                <span style="color: red" id="customerNameSpan"></span>
                <@spring.message "hpms.mdm.receipt.advancediv2"/>
                <span style="color: red" id="advanceSpan"></span>
                <@spring.message "hpms.mdm.receipt.advancediv3"/>
                <script>
                    $("#advanceId").kendoCheckbox({
                        change:function(e){
                            let value = this.value();
                            if (value==='Y') {

                                var sumPrice = viewModel.model.sumPrice;
                                if (sumPrice < advanceAmount) {
                                    viewModel.model.set("receiptAmount", sumPrice);
                                } else if (sumPrice > advanceAmount) {
                                    viewModel.model.set("receiptAmount", advanceAmount);
                                }
                                viewModel.model.set("operationType", "advanceReceivable");

                            } else {
                                viewModel.model.set("receiptAmount", 0);
                            }

                        }
                    });
                </script>
            </div>
            <div style="clear:both;margin-top: 10px">
                <div id="receivableGrid"></div>
            </div>
        </div>
        <!--应收调整-->
        <div>
            <div style="clear:both">
                <div id="adjustmentGrid"></div>
            </div>
        </div>
        <!--预收-->
        <div>
            <div style="clear:both">
                <div id="advanceGrid"></div>
            </div>
        </div>
        <!--押金-->
        <div>
            <div style="clear:both">
                <div id="depositGrid"></div>
            </div>
        </div>
        <!--代收代付-->
        <div>
            <div style="clear:both">
                <div id="collectionGrid"></div>
            </div>
        </div>
        <!--所有-->
        <div>
            <div style="clear:both">
                <div id="allGrid"></div>
            </div>
        </div>
    </div>


</div>

<script type="text/javascript">

    $("#tabstrip").kendoTabStrip({
        animation: {
            open: {
                effects: "fadeIn"
            }
        },
        select: function (e) {
            console.log(e.item.id);
            if (e.item.id==='advance') {
                viewModel.model.set("type","advance");
                $('#advanceGrid').data('kendoGrid').dataSource.page(1);
                type = 'advance';
                $("#moveoutBtn").hide();
                $("#addFeeBtn").hide();
                $("#receiptBtn").show();


            }

            if (e.item.id==='all') {
                viewModel.model.set("type","all");
                type = 'all';
                $('#allGrid').data('kendoGrid').dataSource.page(1);
                $("#moveoutBtn").hide();
                $("#addFeeBtn").hide();
                $("#receiptBtn").hide();


            }

            if (e.item.id==='deposit') {
                type = 'deposit';
                viewModel.model.set("type","deposit");
                let grid = $('#depositGrid').data('kendoGrid');
                grid.dataSource.page(1);

                $("#moveoutBtn").hide();
                $("#addFeeBtn").show();
                $("#receiptBtn").show();


            }

            if (e.item.id==='receivable') {

                $.ajax({
                    url: '${base.contextPath}/fin/receipt/query?type=advance&occupationId='+(viewModel.model.get("occupationId") || 0),
                    type: "POST",
                    dataType: "json",
                    async:false,
                    contentType: "application/json",
                    success: function (args) {
                        var data = args.rows || [];
                        advanceAmount = 0;
                        for (let k of data) {
                            advanceAmount += k.receiptAmount;
                        }
                        if (advanceAmount > 0) {
                            $("#advanceDiv").show();
                            $("#advanceSpan").text(advanceAmount);

                        } else {
                            $("#advanceDiv").hide();
                        }
                    }
                });

                viewModel.model.set("type","receivable");
                $('#receivableGrid').data('kendoGrid').dataSource.page(1);
                type = 'receivable';
                $("#moveoutBtn").show();
                $("#addFeeBtn").show();
                $("#receiptBtn").show();

            }

            if (e.item.id==='adjustment') {
                viewModel.model.set("type","adjustment");
                $('#adjustmentGrid').data('kendoGrid').dataSource.page(1);
                type = 'adjustment';
                $("#moveoutBtn").hide();
                $("#addFeeBtn").hide();
                $("#receiptBtn").show();

            }

            if (e.item.id==='collection') {
                viewModel.model.set("type","collection");
                $('#collectionGrid').data('kendoGrid').dataSource.page(1);
                type = 'collection';
                $("#moveoutBtn").hide();
                $("#addFeeBtn").show();
                $("#receiptBtn").show();


            }
        }
    });

    $("#receiptDateId").kendoDatePicker({
        format: "yyyy-MM-dd"
    });

    $("#customerNameId").kendoLov({
        //三个必须参数：code、contextPath、locale，其他参数    根据实际情况自行设置
        code:"HPMS_RECEIPT_SELECT",
        contextPath:'${base.contextPath}',
        locale:'${base.locale}',
        query:function (e) {
            e.param.projectId = viewModel.model.get("projectId");
        },
        change:function (e) {
            viewModel.model.set("customerCode",e.sender._dataItem.customerCode);
            viewModel.model.set("customerId", e.sender._dataItem.customerId);
            viewModel.model.set("propertyNumber", e.sender._dataItem.propertyNumber);
            viewModel.model.set("propertyName", e.sender._dataItem.propertyName);
            viewModel.model.set("occupationId", e.sender._dataItem.occupationId);
            $("#receivable").removeClass("k-state-active");
            $("#tabstrip").data("kendoTabStrip").select(0);

            $("#customerNameSpan").text(e.sender._dataItem.customerName);



        },
        textField: 'fullName'
    });

    $("#receiptMethodId").kendoDropDownList({
        optionLabel: '<@spring.message "hpms.mdm.equipmenttype.select"/>',
        dataTextField:"paymentMethodName",
        dataValueField:"paymentMethodCode",
        valuePrimitive:true,
        index:1,
        dataSource: {
            transport: {
                read: {
                    url:"${base.contextPath}/mdm/paymentMethod/paymentMethodQuery",
                    type : "POST"
                },
                contentType : "application/json"
            },
            schema: {
                data: 'rows'
            }
        }
    });

    $("#receiptTermId").kendoDropDownList({
        optionLabel: '<@spring.message "hpms.mdm.equipmenttype.select"/>',
        dataTextField:"paymentTermName",
        dataValueField:"paymentTermCode",
        valuePrimitive:true,
        index:1,
        dataSource: {
            transport: {
                read: {
                    url:"${base.contextPath}/mdm/paymentTerm/paymentTermQuery",
                    type : "POST"
                },
                contentType : "application/json"
            },
            schema: {
                data: 'rows'
            }
        }
    });

    $("#companyId").kendoDropDownList({
        optionLabel: '<@spring.message "hpms.mdm.equipmenttype.select"/>',
        dataTextField:"companyFullName",
        dataValueField:"companyId",
        valuePrimitive:true,
        dataSource: {
            transport: {
                read: {
                    url:"${base.contextPath}/fnd/company/query",
                    type : "POST"
                },
                contentType : "application/json"
            },
            schema: {
                data: 'rows'
            }
        }
    });

    $("#projectId").kendoDropDownList({
        optionLabel: '<@spring.message "hpms.mdm.equipmenttype.select"/>',
        dataTextField:"projectName",
        dataValueField:"projectId",
        cascadeFrom:"companyId",
        valuePrimitive:true,
        dataSource: {
            transport: {
                read: {
                    url:"${base.contextPath}/hpms/mdm/project/query",
                    type : "POST"
                },
                contentType : "application/json",
                parameterMap: function(options, type) {
                    if (type === "read") {
                        return {startDateActive:new Date(),endDateActive:new Date()};
                    }
                }
            },
            schema: {
                data: 'rows'
            }
        },
        select: function (e) {

        }
    });


    $('#query-form input').keydown(function (e) {
        if (e.keyCode == 13) {
            e.target.blur();
            viewModel.queryResource(e);
        }
    });

    var BaseUrl = "${base.contextPath}/fin/receipt";

    var receiptDataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: function () {
                    return BaseUrl + "/query?occupationId="+(viewModel.model.get("occupationId") || 0);
                },
                type: "POST",
                dataType: "json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    viewModel.model.set("feeStatus","COUNTED");

                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "receiptId",
                fields: {
                    receiptDate:{type:"date"}
                }
            }
        }
    });

    $("#receivableGrid").kendoGrid({
        autoBind: false,
        dataSource: receiptDataSource,
        height: '500px',
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable:"multiple,rowbox",
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        editable: false,
        columns: [
            {
                field: "feeListCode",
                title: '<@spring.message "hpms.fin.feelist.feelistcode"/>',
                attributes: {style: "text-align:center"},
                width: 200
            },
            {
                field: "feeStatusName",
                title: '<@spring.message "hpms.mdm.receipt.feestatusname"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "feePeriod",
                title: '<@spring.message "hpms.fin.feelist.feeperiod"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "totalAmount",
                title: '<@spring.message "hpms.fin.invoice.lineamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "settlementAmount",
                title: '<@spring.message "hpms.mdm.receipt.settlementamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "transTypeName",
                title: '<@spring.message "hpms.mdm.fee.transtype"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "overduePayment",
                title: '<@spring.message "hpms.fin.feelist.overduepayment"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "remark",
                title: '<@spring.message "hpms.mdm.occupation.remarks"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "docType",
                title: '<@spring.message "hpms.mdm.receipt.docType"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                template:function (dataItem) {
                    var v = dataItem.docType;
                    $.each(docTypeData,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v || "";
                }
            }
        ],
        dataBound:function (e) {


            $("#receivableGrid .k-rowbox").bind("click", function (e) {
                e.stopPropagation();

                var grid = $("#receivableGrid").data("kendoGrid");

                $(e.target.parentNode.parentNode).toggleClass("k-state-selected");

                // 处理全选框
                var head = $(".k-headbox");
                if (grid.items().length===grid.select().length){
                    if (!head.hasClass("fa fa-check")){
                        head.addClass("fa fa-check");
                    }
                } else {
                    if (head.hasClass("fa fa-check")){
                        head.removeClass("fa fa-check");
                    }
                }

                sumPrice(grid);
            });
        }
    });

    $("#adjustmentGrid").kendoGrid({
        autoBind: false,
        dataSource: receiptDataSource,
        height: '500px',
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable:"multiple,rowbox",
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        editable: false,
        columns: [
            {
                field: "feeListCode",
                title: '<@spring.message "hpms.fin.feelist.feelistcode"/>',
                attributes: {style: "text-align:center"},
                width: 200
            },
            {
                field: "feeStatusName",
                title: '<@spring.message "hpms.mdm.receipt.feestatusname"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "feePeriod",
                title: '<@spring.message "hpms.fin.feelist.feeperiod"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "totalAmount",
                title: '<@spring.message "hpms.fin.invoice.lineamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "settlementAmount",
                title: '<@spring.message "hpms.mdm.receipt.settlementamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "transTypeName",
                title: '<@spring.message "hpms.mdm.fee.transtype"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "adjAmount",
                title: '<@spring.message "hpms.fin.feelist.adjamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "overduePayment",
                title: '<@spring.message "hpms.fin.feelist.overduepayment"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "remark",
                title: '<@spring.message "hpms.mdm.occupation.remarks"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "docType",
                title: '<@spring.message "hpms.mdm.receipt.docType"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                template:function (dataItem) {
                    var v = dataItem.docType;
                    $.each(docTypeData,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v || "";
                }
            }
        ],
        dataBound:function (e) {

            $("#adjustmentGrid .k-rowbox").bind("click", function (e) {
                e.stopPropagation();

                var grid = $("#adjustmentGrid").data("kendoGrid");

                $(e.target.parentNode.parentNode).toggleClass("k-state-selected");

                // 处理全选框
                var head = $(".k-headbox");
                if (grid.items().length===grid.select().length){
                    if (!head.hasClass("fa fa-check")){
                        head.addClass("fa fa-check");
                    }
                } else {
                    if (head.hasClass("fa fa-check")){
                        head.removeClass("fa fa-check");
                    }
                }

                sumPrice(grid);
            });


        }
    });

    $("#advanceGrid").kendoGrid({
        autoBind: false,
        dataSource: receiptDataSource,
        height: '500px',
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable:"multiple,rowbox",
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        editable: false,
        columns: [
            {
                field: "receiptNum",
                title: '<@spring.message "hpms.mdm.receipt.receiptnum"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "lineNumber",
                title: '<@spring.message "hpms.mdm.receipt.linenumber"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "receiptStatusName",
                title: '<@spring.message "hpms.mdm.receipt.receiptstatusname"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "receiptDate",
                title: '<@spring.message "hpms.mdm.receipt.receiptdate"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                format: "{0:yyyy-MM-dd}"
            },
            {
                field: "feeName",
                title: '<@spring.message "hpms.mdm.priceline.fee"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "receiptAmount",
                title: '<@spring.message "hpms.fin.invoice.lineamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "transTypeName",
                title: '<@spring.message "hpms.mdm.fee.transtype"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "remark",
                title: '<@spring.message "hpms.mdm.occupation.remarks"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "docType",
                title: '<@spring.message "hpms.mdm.receipt.docType"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                template:function (dataItem) {
                    var v = dataItem.docType;
                    $.each(docTypeData,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v || "";
                }
            }
        ]
    });

    $("#depositGrid").kendoGrid({
        autoBind: false,
        dataSource: receiptDataSource,
        height: '500px',
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable:"multiple,rowbox",
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        editable: false,
        columns: [
            {
                field: "feeListCode",
                title: '<@spring.message "hpms.fin.feelist.feelistcode"/>',
                attributes: {style: "text-align:center"},
                width: 150
            },
            {
                field: "feeStatusName",
                title: '<@spring.message "hpms.mdm.receipt.feestatusname"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "receiptNum",
                title: '<@spring.message "hpms.mdm.receipt.receiptnum"/>',
                attributes: {style: "text-align:center"},
                width: 150,
                template:function (dataItem) {
                    let v = dataItem.docType;
                    if (v==='RE'){
                        return '<a style="text-decoration:none; color:blue; cursor:pointer;" ' +
                            'onclick="refund('+dataItem.receiptId+')">' +
                            dataItem.receiptNum +
                            '</a>';
                    }else {
                        return dataItem.receiptNum || '';
                    }
                }
            },
            {
                field: "lineNumber",
                title: '<@spring.message "hpms.mdm.receipt.linenumber"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "receiptStatusName",
                title: '<@spring.message "hpms.mdm.receipt.receiptstatusname"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "feePeriod",
                title: '<@spring.message "hpms.fin.feelist.feeperiod"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "receiptDate",
                title: '<@spring.message "hpms.mdm.receipt.receiptdate"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                format: "{0:yyyy-MM-dd}"
            },
            {
                field: "feeName",
                title: '<@spring.message "hpms.mdm.priceline.fee"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "totalAmount",
                title: '<@spring.message "hpms.fin.invoice.lineamount"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                template:function (dataItem) {
                    let v = dataItem.docType;
                    if (v==='AR'){
                        return dataItem.totalAmount || '';
                    }else {
                        return dataItem.receiptAmount || '';
                    }
                }
            },
            {
                field: "settlementAmount",
                title: '<@spring.message "hpms.mdm.receipt.settlementamount"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                template:function (dataItem) {
                    if (dataItem.docType==='RE' && dataItem.receiptStatus==='C'){
                        return 0;
                    }else {
                        return dataItem.settlementAmount;
                    }
                }
            },
            {
                field: "transTypeName",
                title: '<@spring.message "hpms.mdm.fee.transtype"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "overduePayment",
                title: '<@spring.message "hpms.fin.feelist.overduepayment"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "remark",
                title: '<@spring.message "hpms.mdm.occupation.remarks"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "docType",
                title: '<@spring.message "hpms.mdm.receipt.docType"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                template:function (dataItem) {
                    var v = dataItem.docType;
                    $.each(docTypeData,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v || "";
                }
            }
        ]
    });

    $("#collectionGrid").kendoGrid({
        autoBind: false,
        dataSource: receiptDataSource,
        height: '500px',
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable:"multiple,rowbox",
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        editable: false,
        columns: [
            {
                field: "feeListCode",
                title: '<@spring.message "hpms.fin.feelist.feelistcode"/>',
                attributes: {style: "text-align:center"},
                width: 200
            },
            {
                field: "feeStatusName",
                title: '<@spring.message "hpms.mdm.receipt.feestatusname"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "feePeriod",
                title: '<@spring.message "hpms.fin.feelist.feeperiod"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "totalAmount",
                title: '<@spring.message "hpms.fin.invoice.lineamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "settlementAmount",
                title: '<@spring.message "hpms.mdm.receipt.settlementamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "transTypeName",
                title: '<@spring.message "hpms.mdm.fee.transtype"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "overduePayment",
                title: '<@spring.message "hpms.fin.feelist.overduepayment"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "remark",
                title: '<@spring.message "hpms.mdm.occupation.remarks"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "docType",
                title: '<@spring.message "hpms.mdm.receipt.docType"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                template:function (dataItem) {
                    var v = dataItem.docType;
                    $.each(docTypeData,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v || "";
                }
            }
        ],
        dataBound:function (e) {

            $("#collectionGrid .k-rowbox").bind("click", function (e) {
                e.stopPropagation();

                var grid = $("#collectionGrid").data("kendoGrid");

                $(e.target.parentNode.parentNode).toggleClass("k-state-selected");

                // 处理全选框
                var head = $(".k-headbox");
                if (grid.items().length===grid.select().length){
                    if (!head.hasClass("fa fa-check")){
                        head.addClass("fa fa-check");
                    }
                } else {
                    if (head.hasClass("fa fa-check")){
                        head.removeClass("fa fa-check");
                    }
                }

                sumPrice(grid);
            });


        }
    });

    $("#allGrid").kendoGrid({
        autoBind: false,
        dataSource: receiptDataSource,
        height: '500px',
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable:"multiple,rowbox",
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        editable: false,
        columns: [
            {
                field: "feeListCode",
                title: '<@spring.message "hpms.fin.feelist.feelistcode"/>',
                attributes: {style: "text-align:center"},
                width: 150
            },
            {
                field: "referenceNumber",
                title: '<@spring.message "hpms.fin.feelist.referencenumber"/>',
                attributes: {style: "text-align:center"},
                width: 150
            },
            {
                field: "feeStatusName",
                title: '<@spring.message "hpms.mdm.receipt.feestatusname"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "receiptNum",
                title: '<@spring.message "hpms.mdm.receipt.receiptnum"/>',
                attributes: {style: "text-align:center"},
                width: 150
            },
            {
                field: "lineNumber",
                title: '<@spring.message "hpms.mdm.receipt.linenumber"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "receiptStatusName",
                title: '<@spring.message "hpms.mdm.receipt.receiptstatusname"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "feePeriod",
                title: '<@spring.message "hpms.fin.feelist.feeperiod"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "receiptDate",
                title: '<@spring.message "hpms.mdm.receipt.receiptdate"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                format: "{0:yyyy-MM-dd}"
            },
            {
                field: "feeName",
                title: '<@spring.message "hpms.mdm.priceline.fee"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "totalAmount",
                title: '<@spring.message "hpms.fin.invoice.lineamount"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                template:function (dataItem) {
                    let v = dataItem.docType;
                    if (v==='AR'){
                        return dataItem.totalAmount || '';
                    }else {
                        return dataItem.receiptAmount || '';
                    }
                }
            },
            {
                field: "settlementAmount",
                title: '<@spring.message "hpms.mdm.receipt.settlementamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "transTypeName",
                title: '<@spring.message "hpms.mdm.fee.transtype"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "adjAmount",
                title: '<@spring.message "hpms.fin.feelist.adjamount"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },

            {
                field: "overduePayment",
                title: '<@spring.message "hpms.fin.feelist.overduepayment"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "remark",
                title: '<@spring.message "hpms.mdm.occupation.remarks"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "docType",
                title: '<@spring.message "hpms.mdm.receipt.docType"/>',
                attributes: {style: "text-align:center"},
                width: 120,
                template:function (dataItem) {
                    var v = dataItem.docType;
                    $.each(docTypeData,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v || "";
                }
            }
        ]
    });


    function sumPrice(grid) {
        var sum = 0;
        var adjAmountSum = 0;
        for (var dataItem of grid.selectedDataItems()){
            adjAmountSum += dataItem.adjAmount;
            sum += dataItem.settlementAmount;
        }
        viewModel.model.set("sumPrice",sum.toFixed(2));
        viewModel.model.set("adjAmount",adjAmountSum.toFixed(2));
    }

    $("thead>tr th").css("text-align","center");

    $("#receivableGrid .k-headbox").on("click", function (e) {
        // 阻止事件冒泡
        e.stopPropagation();

        // 打钩
        $(e.target).toggleClass("fa fa-check");

        var grid = $("#receivableGrid").data("kendoGrid");

        //  处理每一行的checkbox
        var arr = grid.items();
        for(var node of arr){
            if ($(e.target).hasClass("fa fa-check")){
                if (!$(node).hasClass("k-state-selected")){
                    $(node).addClass("k-state-selected")
                }
            }else {
                if ($(node).hasClass("k-state-selected")){
                    $(node).removeClass("k-state-selected")
                }
            }
        }

        sumPrice(grid);
    });
    $("#collectionGrid .k-headbox").on("click", function (e) {
        // 阻止事件冒泡
        e.stopPropagation();

        // 打钩
        $(e.target).toggleClass("fa fa-check");

        var grid = $("#collectionGrid").data("kendoGrid");

        //  处理每一行的checkbox
        var arr = grid.items();
        for(var node of arr){
            if ($(e.target).hasClass("fa fa-check")){
                if (!$(node).hasClass("k-state-selected")){
                    $(node).addClass("k-state-selected")
                }
            }else {
                if ($(node).hasClass("k-state-selected")){
                    $(node).removeClass("k-state-selected")
                }
            }
        }

        sumPrice(grid);
    });
    $("#adjustmentGrid .k-headbox").on("click", function (e) {
        // 阻止事件冒泡
        e.stopPropagation();

        // 打钩
        $(e.target).toggleClass("fa fa-check");

        var grid = $("#adjustmentGrid").data("kendoGrid");

        //  处理每一行的checkbox
        var arr = grid.items();
        for(var node of arr){
            if ($(e.target).hasClass("fa fa-check")){
                if (!$(node).hasClass("k-state-selected")){
                    $(node).addClass("k-state-selected")
                }
            }else {
                if ($(node).hasClass("k-state-selected")){
                    $(node).removeClass("k-state-selected")
                }
            }
        }

        sumPrice(grid);
    });



</script>
</body>
</html>