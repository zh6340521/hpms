<#--
        * description:公表分摊结果显示界面
        * author:fuchun.hu@hand-china.com
        * version: 1.0
        *
        -->
    <#include "../include/header.html">
<body>
<style>
    span[class='k-window-title'] {
        user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
    }

    span[class^="l-icon-"] {
        width: 20px;
        height: 16px;
        overflow: hidden;
        display: inline-block;
    }

    span.red {
        color: red;
        font-weight: bold;
    }



</style>
<script src="${base.contextPath}/common/code?shareRuleData=HPMS_SHARE_RULE" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?enterStatusData=HPMS_METER_ENTER_STATUS" type="text/javascript"></script>

<script type="text/javascript">
    var viewModel = kendo.observable({
        model:{},

        //查询
        queryResource: function (e) {
            $("#grid").data("kendoGrid").dataSource.page(1);
        },

        // 重置查询框
        resetForm: function (e) {
            var formDate = viewModel.model.toJSON();
            for (var k in formDate) {
                viewModel.model.set(k, undefined);
            }
            $("#grid").data("kendoGrid").dataSource.page(1);
        },

        //转入计费
        changeStatus: function (e) {
            var grid = $("#grid").data("kendoGrid");
            //获得表格内的所有数据
            var requestData = [];
            var checked = dataSource.data();

            $.each(checked,function(i,v){
                requestData.push(v);
            })

            kendo.ui.showConfirmDialog({
                title:$l('hap.tip.info'),
                message: $l('确定转入计费吗？')
            }).done(function(event){
                if(event.button=='OK'){

                    $.ajax({
                        url: "${base.contextPath}/fin/metershareresult/changeStatus",
                        data       : kendo.stringify(requestData),
                        type       : 'post',
                        contentType: "application/json",
                        cache      : false,
                        dataType   : 'json',
                        success: function(json) {
                            if(json.success){
                                kendo.ui.showInfoDialog({
                                    message:'<@spring.message "hap.tip.success"/>'
                                }).done(function(e){
                                    //同步grid
                                   // grid.dataSource.sync();
                                    $("#grid").data("kendoGrid").dataSource.page(1);


                                })

                            }
                        }
                    });
                }
            })


        }


    });



</script>

<!--***************************查询字段分割线*****************************-->
<div id="page-content">
    <div class="panel" style="padding: 0px;border:none;box-shadow: none;">
        <form class="form-horizontal" id="query-form" style="margin-top: 1px;">
            <div class="panel-body">

                <div class="row" style="margin-bottom: 5px;">
                    <!-- 公司 -->
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.property.company"/></label>
                            <div class="col-sm-8">
                                <input type="text" id="companyId" style="width: 160px"
                                       data-bind="value:model.companyId">
                                <script>
                                    $("#companyId").kendoComboBox({
                                        valuePrimitive: true,  //原始值
                                        dataTextField: "companyFullName",
                                        dataValueField: "companyId",
                                        dataSource: {
                                            transport: {
                                                read: {
                                                    url:"${base.contextPath}/mdm/property/companyQuery",
                                                    type : "POST"
                                                },
                                                contentType : "application/json",
                                            },
                                            schema: {
                                                data: 'rows'
                                            }
                                        },
                                        change:function(e){
                                            //改变值时将带出的值也消失
                                            if(this.value()==null||this.value()==""){
                                                document.getElementById("projectId").value = "";
                                                document.getElementById("equipmentId").value = "";
                                            }

                                        },
                                    });
                                </script>
                            </div>
                        </div>
                    </div>

                    <!-- 项目 -->
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.property.project"/></label>
                            <div class="col-sm-8">
                                <input type="text" id="projectId" style="width: 160px"
                                       data-bind="value:model.projectId">
                            </div>
                            <script>
                                $("#projectId").kendoComboBox({
                                    autoBind: false,
                                    valuePrimitive: true,
                                    cascadeFrom: "companyId",  //联动绑定的参数
                                    cascadeFromField: "companyId",
                                    filter: "contains",
                                    dataTextField: "projectName",
                                    dataValueField: "projectId",
                                    dataSource: {
                                        serverFiltering:true,
                                        transport: {
                                            read: {
                                                url:"${base.contextPath}/mdm/property/projectQuery",
                                                type : "POST"
                                            },
                                            contentType : "application/json",
                                            parameterMap: function(options, type) {
                                                if (type === "read") {
                                                    var filter = options.filter.filters[0]
                                                    var map = {};
                                                    map[filter.field] = filter.value;
                                                    return map;
                                                }
                                            }
                                        },
                                        schema: {
                                            data: 'rows'
                                        }
                                    },
                                }) ;
                            </script>

                        </div>
                    </div>

                    <!-- 仪表类型 -->
                   <div class="col-sm-3">
                        <div class="form-group">
                            <label class="col-sm-4 control-label">仪表类型</label>
                            <div class="col-sm-8">
                                <input type="text" id="equipmentTypeId" style="width: 160px"
                                       data-bind="value:model.equipmentTypeId">
                            </div>
                            <script>
                               $("#equipmentTypeId").kendoComboBox({
                                   autoBind: false,
                                   valuePrimitive: true,
                                   cascadeFrom: "projectId",  //联动绑定的参数
                                   cascadeFromField: "projectId",
                                   filter: "contains",
                                   dataTextField: "typeName",
                                   dataValueField: "equipmentTypeId",
                                   dataSource: {
                                       serverFiltering:true,
                                       transport: {
                                           read: {
                                               url: "${base.contextPath}/fin/metershareresult/queryEquipmentId",
                                               type : "POST"
                                           },
                                           contentType : "application/json",
                                           parameterMap: function(options, type) {
                                               if (type === "read") {
                                                   var filter = options.filter.filters[0]
                                                   var map = {};
                                                   map[filter.field] = filter.value;
                                                   return map;
                                               }
                                           }
                                       },
                                       schema: {
                                           data: 'rows'
                                       }
                                   },

                               }) ;

                            </script>

                        </div>
                    </div>
                </div>

                <div class="row" style="margin-bottom: 5px;">
                    <!--仪表编号-->
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label class="col-sm-4 control-label"><@spring.message
                                    "hpms.fin.pubmeter.metercode"/></label>
                            <div class="col-sm-8">
                                <input id="edit1" type="text" style="width: 160px" data-bind="value:model.equipmentId">
                            </div>
                            <script>
                                $("#edit1").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "HPMS_MDM_FIN_SHARE")}, {

                                        }
                                ));
                            </script>
                        </div>
                    </div>


                    <!--分摊规则-->
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label class="col-sm-4 control-label">分摊规则</label>
                            <div class="col-sm-8">
                                <input type="text" id="shareRule" style="width: 160px"
                                       data-bind="value:model.shareRule">
                                <script>
                                    $("#shareRule").kendoComboBox({
                                        valuePrimitive: true,
                                        dataTextField: "meaning",
                                        dataValueField: "value",
                                        dataSource: shareRuleData
                                    });
                                </script>
                            </div>
                        </div>
                    </div>

                    <!--状态-->
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label class="col-sm-4 control-label">状态</label>
                            <div class="col-sm-8">
                                <input  type="text" id="status" style="width: 160px"
                                       data-bind="value:model.status">

                                <script>
                                    $("#status").kendoComboBox({
                                        valuePrimitive: true,
                                        dataTextField: "meaning",
                                        dataValueField: "value",
                                        dataSource: enterStatusData
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
        </form>
    </div>
    <!--将form和viewmodel进行绑定-->
    <script>kendo.bind($('#query-form'), viewModel);</script>

    <div class="row" style="margin-left: 0px;margin-bottom: 10px">
        <div id="toolbar-btn" style="padding-bottom: 10px;">
                        <span class="btn btn-primary k-grid-add"
                              style="float: left; margin-right: 5px;"
                              onclick="addShare()">
                            <i class="fa fa-plus-square" style="margin-right:3px;"></i>分摊</span>

                        <span class="btn btn-primary k-grid-add"
                             style="float: left; margin-right: 5px;"
                              data-bind="click:changeStatus">转入计费</span>
                        <span class="btn btn-primary k-grid-save-changes"
                              style="float: left; margin-right: 5px;"
                              data-bind="click:queryResource">
                            <i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
                         <span class="btn btn-default" style="float:left;width:70px" data-bind="click:resetForm"
                               type="button"><i class="glyphicon glyphicon-erase" style="margin-right:3px;"></i><@spring.message "hap.reset"/></span>

        </div>
    </div>


    <!--将按钮绑定到viewmodel上-->
    <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
    <div style="clear: both;">
        <div id="grid"></div>
    </div>

    <div id="createShareWin"></div>
</div>



<script>
    //点击【分摊】出现弹框
    function addShare(){
        $("#createShareWin").kendoWindow({
            actions: ["Close"],
            title: $l('分摊'),
            draggable: true,
            width: "850px",
            height:"450px",
            content: "${base.contextPath}/fin/meter_share_query.html",
            iframe: true,
            modal: true,
            close: function(){
                $("#createShareWin").empty();

            }
        });
        var win = $("#createShareWin").data("kendoWindow");
        win.center().open();
    }





    <!--*******************************我是grid分割线**********************************-->
    var crudServiceBaseUrl = "${base.contextPath}/fin/metershareresult",
            dataSource = new kendo.data.DataSource({
                transport: {
                    read:  {
                        url: crudServiceBaseUrl + "/query",
                        type : "POST",
                        dataType: "json"
                    },
                    create : {
                        url : crudServiceBaseUrl + "/submit",
                        contentType: "application/json",
                        type : "POST",
                        success : function(e){
                            alert(e);
                        },
                        error:function(e){
                            alert(e);
                        }
                    },
                    update : {
                        url : crudServiceBaseUrl + "/changeStatus",
                        contentType: "application/json",
                        type : "POST",

                    },
                    destroy: {
                        url: crudServiceBaseUrl + "/remove",
                        contentType: "application/json",
                        type: "POST"
                    },
                    parameterMap: function(options, type) {
                        if (type !== "read" && options.models) {
                            //判断状态
                            var datas = Hap.prepareSubmitParameter(options, type);
                            //从一个对象解析出字符串
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                        }
                    }
                },
                batch: true,
                serverPaging : true,//是否在服务器端分页
                pageSize: 10,
                schema: {
                    data:'rows',
                    total:'total',
                    model: {
                        id: "shareResultId",   //标记信息状态的属性，不然没法根据状态判断是add还是update
                        fields: {
                            //默认版本
                           /* defaultVersion:{defaultValue: 'N',type: 'boolean',checkedValue:'Y',uncheckedValue:'N'},
                            companyId:{},
                            projectName:{},
                            projectId :{},
                            companyFullName:{},*/

                        }

                    },
                    /* requestEnd: function(e) {
                         if (e.type != "read"){
                             dataSource.page(1);
                         }
                     }*/
                    requestEnd: function(e) {
                        if (e.response.success && e.type != "read") {
                            kendo.ui.showInfoDialog({
                                message:'<@spring.message "hap.tip.success"/>'
                            })
                        }else{
                            this.cancelChanges();
                        }
                    },
                }
            });

    //手动创建数据源


    var grid = $("#grid").kendoGrid({
        dataSource : dataSource,
        navigatable: false,
        height: '100%',
        resizable: true,
        scrollable: "multiple,rowbox",
        reorderable: true,
        sortable   : true,
        selectable : "row",
        editable: false,
        columnMenu: true,
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field: "companyName",
                // title: '编码',
                title:'公司',
                width: '120px',
                attributes: {style: "text-align:center"},



            },
            {
                field: "projectName",
                // title: '项目',
                title:"<@spring.message 'hpms.mdm.property.project'/>",
                width: '120px',
                attributes: {style: "text-align:center"},


            },
            {
                field: "invoiceCode",
                // title: '项目',
                title:"发票号",
                width: '120px',
                attributes: {style: "text-align:center"},


            },
            {
                field: "equipmentCode",
                // title: '项目',
                title:"设备编号",
                width: '120px',
                attributes: {style: "text-align:center"},


            },
            {
                field: "equipmentName",
                // title: '项目',
                title:"设备名称",
                width: '200px',
                attributes: {style: "text-align:center"},


            },
            {
                field: "customerName",
                // title: '项目',
                title:"分摊人",
                width: '120px',
                attributes: {style: "text-align:center"},


            },
            {
                field: "propertyName",
                // title: '项目',
                title:"建筑名称",
                width: '200px',
                attributes: {style: "text-align:center"},


            },
            {
                field: "msMount",
                // title: '项目',
                title:"分摊金额",
                width: '120px',
                attributes: {style: "text-align:center"},


            },
            {
                field: "formatCallableDate",
                // title: '项目',
                title:"费用日期",
                format: "{0:yyyy/MM/dd}",
                width: '120px',
                attributes: {style: "text-align:center"},
                template:function (rowdata){

                        return kendo.toString(rowdata.callableDate,"yyyy");

                },



            },
            {
                field: "formatMsDate",
                // title: '项目',
                title:"分摊日期",
                width: '120px',
                attributes: {style: "text-align:center"},


            },
            {
                field: "statusMeanings",
                // title: '项目',
                title:"状态",
                width: '120px',
                attributes: {style: "text-align:center"},


            }],

    }).data("kendoGrid");


    //自动调整
    Hap.autoResizeGrid("#grid");
    //设置表格上的字居中
    $("#grid thead>tr th").css("text-align","center");

</script>
</body>
