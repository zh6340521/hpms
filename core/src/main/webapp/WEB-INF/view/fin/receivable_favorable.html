<#--
 * description: 应收优惠
 * version: 1.0
 * #copyright#
 *author: huifang.zhou@hand-china.com 2017.02.15
-->
<#include "../include/header.html">
<body>
	<script type="text/javascript">
	var viewModel = kendo.observable({
        model: {},
        creatFunction: function(){
            $('#receivable_favorable_grid').data('kendoGrid').addRow();
        },
        saveFunction: function(){
            $('#receivable_favorable_grid').data('kendoGrid').saveChanges();
        },
        queryResource: function (e) {
            $('#receivable_favorable_grid').data('kendoGrid').dataSource.page(1);
        }
    });
    
    
    
	</script>
<div id="room_tree"></div>
<div id="page-content">
	<div id="receivable_favorable_form">
		<form class="form-horizontal" id="pool_form" role="form" style="margin-top: 5px;">
			<div class="row">
				<div class="from-group col-md-4" style="margin-bottom:10px">
					<label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.company'/></label>
				    <div class="col-md-7">
				    	<input id="companyId" name="companyId" data-bind="value:model.companyId" style="width: 90%;"/>
				    </div>
				</div>
				<div class="from-group col-md-4" style="margin-bottom:10px">
					<label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.project'/></label>
					<div class="col-md-7">
						<input id="projectId" name="projectId" data-bind="value:model.projectId" style="width: 90%;"/>
					</div>
				</div>
				<div class="from-group col-md-4" style="margin-bottom:10px">
					<label class="col-md-5 control-label"><@spring.message 'hpms.mdm.customer.customername'/></label>
				    <div class="col-md-7">
				      <input type="text" class="k-textbox" id="customerName" name="customerName"  data-bind="value:model.customerName" style="width: 90%;">
				    </div>
				</div>
			</div>
			<div class="row">
				<div class="from-group col-md-4" style="margin-bottom:10px">
					<label class="col-md-5 control-label"><@spring.message 'hpms.mdm.fin.feecode'/></label>
				    <div class="col-md-7">
				        <input type="text" class="k-textbox" name="propertyNumber"  data-bind="value:model.propertyNumber" style="width: 90%;"/> 
				    </div>
				</div>
				<div class="from-group col-md-4" style="margin-bottom:10px">
					<label class="col-md-5 control-label"><@spring.message 'hpms.mdm.fin.adjust_date'/></label>
				    <div class="col-md-7">
				    	<input id="discountDate" name="discountDate" data-bind="value:model.discountDate" style="width: 90%;" type="date" k-format="'yyyy-MM-dd'"/>
				    	<script type="text/javascript">
										$("#discountDate").kendoDatePicker({
											format : "yyyy-MM-dd"
										});
						</script>
				    </div>
				</div>
				<div class="from-group col-md-4" style="margin-bottom:10px">
					<label class="col-md-5 control-label"><@spring.message 'hpms.mdm.discountpro.discountpro'/></label>
				    <div class="col-md-7">
				    	<input id="transType" type="text" class="k-textbox" name="transType" data-bind="value:model.transType" style="width: 90%;"/>
				    </div>
				</div>
			</div>
		</form>
	</div>
	<script>kendo.bind($('#receivable_favorable_form'), viewModel);</script>
	<div class="pull-left" id="toolbar-btn" style="clear:both;padding-bottom:10px;padding-top:20px;">
        <span class="btn btn-primary k-grid-add" style="float: left; margin-right: 5px;" data-bind="click:creatFunction">
             <i class="fa fa-plus-square" style="margin-right:3px;"></i><@spring.message "hap.new"/></span>
        <span class="btn btn-primary k-grid-save-changes" style="float: left; margin-right: 5px;" data-bind="click:saveFunction">
             <i class="fa fa-save" style="margin-right:3px;"></i><@spring.message "hap.save"/></span>
        <span class="btn btn-primary k-grid-save-changes" style="float: left; margin-right: 5px;" data-bind="click:queryResource">
             <i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
	</div>
	 <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
	<div style="clear:both">
        <div id="receivable_favorable_grid" ></div>
    </div>
</div>
	<script type="text/javascript" >
		$('#receivable_favorable_form input').keydown(function (e) {
		    if (e.keyCode == 13) {
		        e.target.blur();
		        viewModel.queryResource(e);
		    }
		});
		
		$("#companyId").kendoComboBox({
		  valuePrimitive: true,
		  dataTextField: "companyFullName",
          dataValueField: "companyId",
          dataSource: {
                    transport: {
                    	read:function(options) {
						      $.ajax({
						        type   : "POST",
						        url: "${base.contextPath}/mdm/property/companyQuery",
						        data: {}, 
						        success: function(json) {
						          options.success(json.rows);
						        }
						      });
    					}
                	} 
          }
		});
		$("#projectId").kendoComboBox({
          autoBind: false,
          valuePrimitive: true,
          cascadeFrom: "companyId",
          cascadeFromField: "companyId",
          filter: "contains",
          dataTextField: "projectName",
          dataValueField: "projectId",
          dataSource: {
              serverFiltering:true,
              transport: {
                  read: {
                  	url:"${base.contextPath}/mdm/property/projectQuery",
                  	type : "POST" 
                  }, 
                  contentType : "application/json",
                  parameterMap: function(options, type) {
                  	  console.log(options)
                      if (type === "read") {
                          var filter = options.filter.filters[0]
                          var map = {};
                          map[filter.field] = filter.value;
                          return map;
                      }
                  }
              },
              schema: {
                  data: 'rows'
              }
          }
      }) ;
      
		var dataSource = new kendo.data.DataSource({
	        transport   : {
		        read: {
	                    url: _basePath+ "/hpms/fin/discountDate/query",
	                    type: "POST",
	                    dataType: "json"
	                },
	            create : {
                            url: _basePath+"/hpms/fin/discountDate/save",
                  			type : "POST", 
                            dataType: "json",
                            contentType:"application/json"
                        },
	            parameterMap: function (options, type) {
	                if (type !== "read" && options.models) {
	                    var datas = Hap.prepareSubmitParameter(options, type);
	                    return kendo.stringify(datas);
	                } else if (type === "read") {
	                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
	                }
	            }
	        },
	        requestEnd : function(e) {
						if (e.type != "read") {
							dataSource.page(dataSource._page);
						}

					},
	        batch       : true,
	        serverPaging: true,
	        pageSize    : 10,
	        schema      : {
	            data  : 'rows',
	            total : 'total',
	            model : {
	                id    : "discountProId",
	                fields: {
	                	discountDate: {type:"date"},
	                }
	            }
	        }
	    }); 
	    //手动创建数据源
	  var Amunts;
	  var feeByName;
	  var Dates;
	  var toDate;
	  var fromDate;
      var Companyid;
      var Projectid;
      var companyInfo=[];
      var projectInfo=[];
    var grid=$("#receivable_favorable_grid").kendoGrid({
      dataSource : dataSource,
          navigatable: false,
          height     : "100%",
          resizable  : true,
          scrollable : true,
          autoBind   : true,
          editable   : "inline",
          selectable : "multiple,rowbox",
          reorderable: true,
          sortable   : true,
          columnMenu : true, //实现右击可以隐藏显示列
          pageable   : {
              pageSizes  : [5, 10, 20, 50],
              refresh    : true,
              buttonCount: 5
          },
          columns    : [{
                  field      : "complanyId",
                  title      : "<@spring.message 'hpms.mdm.property.company'/>", 
                  width      : 180,
                template: function(dataItem){
                  return dataItem['companyFullName']|| '' 
                },
                editor: function(container, options){
                    $.ajax({
                      url : '${base.contextPath}/mdm/property/companyQuery',
                      type : 'POST',
                      contentType : "application/json;charset=utf-8",
                      cache : false,
                      dataType : 'json',
                      async : false,
                      success : function(data) {
                        companyData = data.rows;
                      }
                     }); 
                  $('<input style="width: 80%;" required validationMessage="<@spring.message "hpms.notempty"/>" name="' + options.field + '"/>').appendTo(container).kendoDropDownList({
                           dataTextField: "companyFullName",
                           dataValueField: "companyId",
                           valuePrimitive: true,
                           dataSource: companyData,
                           select:function(e){ 
             				   Companyid = options.model.complanyId;
             				   if(null == Companyid &&Companyid == undefined){
									$("#projectId2").data("kendoDropDownList").enable(false);
									options.model.set("companyId",null);
								}else{
									$("#projectId2").data("kendoDropDownList").enable(true);
								}
                             options.model.set('projectName',null);
                             options.model.set('projectId',null);
                           $.ajax({
                        url : '${base.contextPath}/mdm/property/projectQuery?companyId='+options.model.complanyId,
                        type : 'POST',
                        contentType : "application/json;charset=utf-8",
                        cache : false,
                        dataType : 'json',
                        async : false,
                        success : function(data) {
                          var dropdownlist = $("#projectId2").data("kendoDropDownList");
                          dropdownlist.setDataSource(data.rows);
                        }
                      });
                           }
                  });
                  $('<span style="color:red">&nbsp;&nbsp;*</span>').appendTo(container);
                }
            },{
              field      : "projectId",
                  title      : "<@spring.message 'hpms.mdm.property.project'/>", 
                  width      : 150,
                  template: function(dataItem){
                  return dataItem['projectName']|| '' 
                },
                editor: function(container, options){
                    $.ajax({
                        url : '${base.contextPath}/mdm/property/projectQuery?companyId='+Companyid,
                        type : 'POST',
                        contentType : "application/json;charset=utf-8",
                        cache : false,
                        dataType : 'json',
                        async : false,
                        success : function(data) {
                          projectData = data.rows;
                        }
                     });
                  $('<input style="width: 80%;" id="projectId2" required validationMessage="<@spring.message "hpms.notempty"/>" name="' + options.field + '"/>')
                             .appendTo(container)
                             .kendoDropDownList({
                                 dataTextField: "projectName",
                                 dataValueField: "projectId",
                                 valuePrimitive: true,
                                 dataSource: projectData,
                                 select:function(e){ 
                                  	Projectid = options.model.projectId;
                                  	if (Projectid == undefined) {
										$("#struName").attr("disabled",false);
									}else {
										$("#struName").attr("disabled",true);
									}
                                  }
                        });
                  $('<span style="color:red">&nbsp;&nbsp;*</span>').appendTo(container);
                }
            },{
            	field      : "propertyName",
                title      : "<@spring.message 'hpms.fin.room'/>", 
                width      : 120,
                editor: function(container, options){
                $('<span class="k-widget k-lov k-header" style="width: 90%;">'+
                 '<span tabindex="-1" unselectable="on" class="k-dropdown-wrap k-state-default">'+
                    '<input id="struName" required name="' + options.field + '" class="k-input" type="text" autocomplete="off" title="" role="lov" aria-expanded="false"  readonly="readonly" style="width: 100%;">'
                        +'<span unselectable="on" class="k-icon k-i-close" title="clear" role="button" tabindex="-1">'
                        +'</span>'+
                    '<span unselectable="on" class="k-select" aria-label="select" role="button" tabindex="-1" onclick="newTree()">'+
                       '<span class="k-icon k-i-search">'+
                       '</span>'+
                    '</span>'+
                 '</span>'+              
            '</span>').appendTo(container);
                }
          },
          {
            field      : "occupationId",
                title      : "<@spring.message 'hpms.mdm.customer.customername'/>", 
                width      : 120,
                editor : function(container, options){
                  $('<input id="occupationId" style="background-color:#DDDDDD" disabled="disabled" class="k-textbox" name="' + options.field + '"/>').appendTo(container);
                },
                hidden:true
         
          },
          {
            field      : "customerName",
                title      : "<@spring.message 'hpms.mdm.customer.customername'/>", 
                width      : 120,
                editor : function(container, options){
                  $('<input id="custName" style="background-color:#DDDDDD" disabled="disabled" class="k-textbox" name="' + options.field + '"/>').appendTo(container);
                }
          },{
            field      : "discountDateFrom",
                title      : "<@spring.message 'hpms.mdm.dies_gratia_begin_date'/>", 
                width      : 120,
                editor : function(container, options) {
              $('<input id="DateFrom" required name="' + options.field + '"/>').appendTo(container).kendoDatePicker({
                		  start: "year",
                          depth: "year",
                          format: "yyyy-MM",
                          change : function() {
                  fromDate = this.value();
                  toDate = $('#DateTo').data('kendoDatePicker').value();
                  if (!!toDate && fromDate > toDate) {
                    $('#DateTo').data('kendoDatePicker').value("");
                  }
                   	$('#DateTo').data('kendoDatePicker').min(fromDate);
                   	fromDate = kendo.toString(fromDate,'yyyy-MM');
                   	//console.log(fromDate);
                   	options.model.set('discountDateFrom',fromDate);
                   	var Id = document.getElementById("occupationId").value;
                   	options.model.set("occupationId",Id);
                   	console.log(options.model.occupationId)
                   	//console.log(options.model.discountDateFrom);
                  }
                 });
                }
          },{
            field      : "discountDateTo",
                title      : "<@spring.message 'hpms.mdm.dies_gratia_end_date'/>", 
                width      : 120,
                format: "{0:yyyy-MM}",
                template: function(dataItem){
                  return dataItem['discountDateTo']|| '' 
                },
                //设置时间只能选择年月
           editor : function(container, options) {
          $('<input id="DateTo" required name="' + options.field + '"/>').appendTo(container).kendoDatePicker({
             		   start: "year",
                       depth: "year",
                       format: "yyyy-MM",
                       change : function() {
			              toDate = this.value();
			              console.log(toDate)
			              toDate  = kendo.toString(toDate,'yyyy-MM');
				          fromDate = $('#DateFrom').data('kendoDatePicker').value();
				              if (!!fromDate && toDate < fromDate){
					                fromDate = $('#StartDate').data('kendoDatePicker').value("");
					                $('#DateFrom').data('kendoDatePicker').max(toDate);
				                }else{
				                	//计算月份差
				                fromDate = kendo.toString(fromDate,'yyyy-MM');
				                toDate  = kendo.toString(toDate,'yyyy-MM');
				                var startDate = fromDate.split('-');
				                startDate = parseInt(startDate[0]) * 12 + parseInt(startDate[1]);
				                var endDate = toDate.split('-');
				                endDate = parseInt(endDate[0]) * 12 + parseInt(endDate[1]);
				                Dates = Math.abs((endDate - startDate)+1);
				                var name = $('#struName').val();
				                $.ajax({
									type   : "POST",
									url: "${base.contextPath}/hpms/fin/discountDate/querySum?propertyName="+name+"&fromDate="+fromDate+"&todate="+toDate,
									data: {}, 
									success: function(datas) {
									Amunts = datas.rows[0].gross;
									console.log(Amunts)
									var item = datas.rows[0].item;
										if (item != Dates) {
											kendo.ui.showInfoDialog({
													message : "该房间在该优惠期间并未生成应收优惠清单!"
											});
											$('#DateTo').data('kendoDatePicker').value("");
										}else if(item == Dates){
											var con = $('#DateFrom').data('kendoDatePicker').value(fromDate);
										}
									}
									})
				                }
				               //options.model.set('discountDateTo',toDate);
				              // console.log(options.model.discountDateTo)
				              }
              });
          }
          },{
            field      : "discountProId",
                title      : "<@spring.message 'hpms.mdm.discountpro.discountpro'/>", 
                width      : 120,
                template: function(dataItem){
                  return dataItem['discountProName']|| '' 
                },
		          editor  : function (container, options) { 
		          var sumAmunt;
		          var adjAmount;
		              $('<input required validationMessage="<@spring.message "hss.notempty"/>" name="' + options.field + '"/>')
		                    .appendTo(container)
		                    .kendoLov($.extend(<@lov "HPMS_MDM_FIN_DISCOUNT_PRO"/>, {
		                    textField: 'discountProName',
		                    model    : options.model,
		                select:function(e){                                        
			                options.model.set('discountProCode',e.item.discountProCode); 
			                options.model.set('discountProName',e.item.discountProName);
			                options.model.set('discountType',e.item.discountType);
			                options.model.set('discountProId',e.item.discountProId);
			                options.model.set('amount',e.item.amount);
			                options.model.set('percent',e.item.percent);
			                var amount = options.model.amount;
			                var percents = options.model.percent;
			                var discountType = options.model.discountType;
			                var discountProName = options.model.discountProName;
			                percents = parseInt(percents)/100
			                console.log(discountType)
			                if (discountType == "RATE") {
								adjAmount = (Amunts*percents).toFixed(2);
								sumAmunt = (Amunts-adjAmount).toFixed(2);
							}else if(discountType == "AMOUNT"){
								adjAmount = amount;
								sumAmunt = Amunts-adjAmount;
							}
								console.log(adjAmount)
								console.log(sumAmunt)
			                console.log(discountProName)
			                $.ajax({
									type   : "POST",
									url: "${base.contextPath}/hpms/fin/discountDate/queryName?discountProName="+discountProName,
									data: {}, 
									success: function(datas) {
									  feeByName = datas.rows[0].feeName;
									  document.getElementById("feeName").value=feeByName;
									  document.getElementById("grossAmount").value=Amunts;
									  document.getElementById("adjAmount").value=adjAmount;
									  document.getElementById("totalAmount").value=sumAmunt;
									  options.model.set("grossAmount",Amunts);
									  options.model.set("adjAmount",adjAmount);
									  options.model.set("totalAmount",sumAmunt);
									}
									})
							
		                },
		                change : function(e){
		                    if (e.sender._prev == '' || e.sender._prev == null) {
		              		 	options.model.set('discountProCode','');
		           				options.model.set('discountProName','');
		              }                                
		        }
		    }));
		    }
		},{
            field      : "feeName",
                title      : "<@spring.message 'hpms.fin.invoice.feename'/>", 
                width      : 120,
                editor : function(container, options){
                  $('<input id="feeName" style="background-color:#DDDDDD" disabled="disabled" class="k-textbox" name="' + options.field + '"/>').appendTo(container);
                }
          },{
            field      : "grossAmount",
                title      : "<@spring.message 'hpms.mdm.paymentmethod.arflag'/>", 
                width      : 120,
                 editor : function(container, options){
                  $('<input id="grossAmount" style="background-color:#DDDDDD" disabled="disabled" class="k-textbox" name="' + options.field + '"/>').appendTo(container);
                  }
          },{
            field      : "adjAmount",
                title      : "<@spring.message 'hpms.mdm.discountpro.discount'/>", 
                width      : 120,
                editor : function(container, options){
                  $('<input id="adjAmount" style="background-color:#DDDDDD" disabled="disabled" class="k-textbox" name="' + options.field + '"/>').appendTo(container);
                }
          },{
            field      : "totalAmount",
                title      : "<@spring.message 'hpms.fin.feelist.amount_rental'/>", 
                width      : 120,
                editor : function(container, options){
                  $('<input id="totalAmount" style="background-color:#DDDDDD" disabled="disabled" class="k-textbox" name="' + options.field + '"/>').appendTo(container);
                }
          },{
            field      : "discountDate",
                title      : "<@spring.message 'hpms.mdm.fin.adjustment_time'/>", 
                width      : 120,
                format: "{0:yyyy-MM-dd}"
          }]
      
    }).data("kendoGrid");
	    Hap.autoResizeGrid("#receivable_favorable_grid");
	    
	    
function newTree(){
	$("#room_tree").kendoWindow({
	            actions: ["Close"],
	            title: $l('<@spring.message "hpms.fin.feelist.choose"/>'),
	            draggable: true,
	            height: "400px",
	            width: "510px",
	            content: '${base.contextPath}/fin/room_tree.html?companyId='+Companyid+'&projectId='+Projectid,
	            iframe: true,
	            modal: true,
	        });
	    	var win = $("#room_tree").data("kendoWindow");
      		win.center().open();
		}
		
		$("#companyId").kendoComboBox({
		  valuePrimitive: true,
		  dataTextField: "companyFullName",
          dataValueField: "companyId",
          dataSource: {
                    transport: {
                    	read:function(options) {
						      $.ajax({
						        type   : "POST",
						        url: "${base.contextPath}/mdm/property/companyQuery",
						        data: {}, 
						        success: function(json) {
						          options.success(json.rows);
						        }
						      });
    					}
                	} 
          }
		});
	</script>
</body>
</html>