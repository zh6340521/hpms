<#include "../include/header.html">
    <body>
    <script src="${base.contextPath}/common/code?resourceTypeData=HPMS_SHARE_RULE" type="text/javascript"></script>
    <script src="${base.contextPath}/common/code?typeData=HPMS_UOM" type="text/javascript"></script>
    <script type="text/javascript">
        // 初始化viewModel
        var viewModel = kendo.observable({
            model: {},
            // 将快码的值设为全局变量
            typeResource: resourceTypeData,
            // 新增函数
            createFunction: function(){
                $("#room_tree").kendoWindow({
                    actions: ["Close"],
                    title: $l('<@spring.message "hpms.fin.feelist.choose"/>'),
                    draggable: true,
                    height: "400px",
                    width: "510px",
                    content: '${base.contextPath}/fin/room_tree.html?companyId='+viewModel.model.companyId+'&projectId='+viewModel.model.projectId,
                    iframe: true,
                    modal: true,
                });
                var win = $("#room_tree").data("kendoWindow");
                win.center().open();
            },

        });

        // 获取chargeRuleId
        var shareRuleId = ${RequestParameters.shareRuleId!0};
        var equipmentId = ${RequestParameters.equipmentId!0};


        var companyArray = null;
        var projectArray = null;
        var equipmentArray = null;
        var eq = [];
        $.ajax({
            type   : "GET",
            url: "${base.contextPath}/fnd/company/query",
            data: '',
            async: false,
            success: function(args) {
                companyArray = args.rows;
            }
        });
        $.ajax({
            type   : "GET",
            url: "${base.contextPath}/hpms/mdm/project/query",
            data: '',
            async: false,
            success: function(args) {
                projectArray = args.rows;
            }
        });
        $.ajax({
            type   : "GET",
            url: "${base.contextPath}/mdm/equipmentType/query",
            data: '',
            async: false,
            success: function(args) {
                equipmentArray = args.rows;
            }
        })
        $.ajax({
            type : "GET",
            url: "${base.contextPath}/hpms/fin/pubmeter/query?equipmentId="+equipmentId,
            data:'',
            async: false,
            success: function(args) {
                console.log(args);
            }
        })
        $.ajax({
            type   : "GET",
            url: '${base.contextPath}/fin/share/query?shareRuleId='+shareRuleId,
            data: '',
            async: false,
            success: function(args) {
                viewModel.model.crName = args.rows[0].crName;
                for(var k in resourceTypeData){
                    if(resourceTypeData[k].value ==args.rows[0].shareRule){
                        viewModel.model.shareRule = resourceTypeData[k].meaning;
                    }
                }
                for(var k in companyArray){
                    if(companyArray[k].companyId ==args.rows[0].companyId){
                        viewModel.model.companyId = companyArray[k].companyId;
                        viewModel.model.companyName = companyArray[k].companyFullName;
                    }
                }
                for(var k in projectArray){
                    if(projectArray[k].projectId ==args.rows[0].projectId){
                        viewModel.model.projectId = projectArray[k].projectId;
                        viewModel.model.projectName = projectArray[k].projectName;
                    }
                }
                for(var k in equipmentArray){
                    if(equipmentArray[k].equipmentTypeId ==args.rows[0].equipmentTypeId){
                        viewModel.model.equipmentTypeId = equipmentArray[k].equipmentTypeId;
                        viewModel.model.typeName = equipmentArray[k].typeName;
                    }
                }
            }
        })

    </script>
    <div id="page-content">
        <div id="room_tree"></div>
        <div class="panel" style="padding: 0px;border:none;box-shadow: none;">
            <form class="form-horizontal" id="query-form" style="margin-top: 1px;">
                <div id="form" class="panel-body">
                    <div class="row" style="margin-bottom: 5px;">
                        <!-- 公司 -->
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">公司</label>
                                <div class="col-sm-8">
                                    <input type="text" style="width: 160px"
                                           data-bind="value:model.companyName"
                                           class="k-textbox"  disabled>
                                </div>
                            </div>
                        </div>
                        <!-- 项目 -->
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">项目</label>
                                <div class="col-sm-8">
                                    <input type="text" style="width: 160px"
                                           data-bind="value:model.projectName"
                                           class="k-textbox"  disabled>
                                </div>
                            </div>
                        </div>
                        <!-- 仪表类型 -->
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">仪表类型</label>
                                <div class="col-sm-8">
                                    <input type="text" style="width: 160px"
                                           data-bind="value:model.typeName"
                                           class="k-textbox"  disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">&nbsp;</label>
                            </div>
                        </div>
                        <!-- 仪表编号 -->
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">仪表编号</label>
                                <div class="col-sm-8">
                                    <input id="ob" type="text" style="width: 160px"
                                           data-bind="value:model.crObject"
                                           class="k-textbox" disabled>
                                </div>
                            </div>
                        </div>
                        <!-- 仪表名称 -->
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">仪表名称</label>
                                <div class="col-sm-8">
                                    <input type="text" style="width: 160px"
                                           data-bind="value:model.crName"
                                           class="k-textbox" disabled>
                                </div>
                            </div>
                        </div>
                        <!-- 分摊规则 -->
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">分摊规则</label>
                                <div class="col-sm-8">
                                    <input id="enable" type="text" style="width: 160px"
                                           data-bind="value:model.shareRule"
                                           class="k-textbox" disabled>
                                </div>
                            </div>
                        </div>
                        <div style="clear:both"></div>
                        <span onclick="viewModel.createFunction()" class="btn btn-info" style="float:left;margin-right:5px;margin-top: 20px;margin-left: -15px"><i class="fa fa-plus-square" style="margin-right:3px;"></i>
	<@spring.message "hap.new"/></span>
                    </div>
                </div>
            </form>
        </div>
        <!-- gird组件 -->
        <div style="clear: both;">
            <div id="grid" style="margin-top: -20px"></div>
        </div>
    </div>
    <script>
        // 绑定数据源
        kendo.bind($('#query-form'), viewModel);
        // 当前路径
        var crudServiceBaseUrl = '${base.contextPath}/fin/sharebind';

        // 定义数据源
        var dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: crudServiceBaseUrl + "/query?shareRuleId="+shareRuleId,
                    type: "GET",
                    dataType: "json"
                },
                create: {
                    url: crudServiceBaseUrl + "/submit",
                    contentType: "application/json",
                    type: "POST"
                },
                update: {
                    url: crudServiceBaseUrl + "/submit",
                    contentType: "application/json",
                    type: "POST"
                },
                destroy: {
                    url: crudServiceBaseUrl + "/delete",
                    contentType: "application/json",
                    type: "DELETE"
                },
                parameterMap: function (options, type) {
                    if (type !== "read" && options.models) {
                        var datas = Hap.prepareSubmitParameter(options, type);
                        return kendo.stringify(datas);
                    } else if (type === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                    }
                },
            },
            requestEnd: function (e) {
                if(e.type=='read'){
                    crcode=e.response.rows;
                }else if(e.type=='create'&&e.response.success==true){
                    kendo.ui.showInfoDialog({
                        message: '添加成功!'
                    });
                } else if(e.type=='destroy'&&e.response.success==true){
                    kendo.ui.showInfoDialog({
                        message: '删除成功!'
                    });
                }else{
                    $('#grid').data('kendoGrid').dataSource.read();
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "shareBingId",
                    fields: {
                    },
                }
            }
        });
        //
        var grid = $('#grid').kendoGrid({
            dataSource: dataSource,
            height: '100%',
            resizable: false,
            scrollable: true,
            selectable: 'row',
            editable: "inline",
            sortable: true,
            navigatable: false,
            reorderable: true,
            pageable: {
                // 分页类别
                pageSizes: [5, 10, 20, 50],
                // 刷新按钮
                refresh: true,
                // 最大显示页面数
                buttonCount: 5
            },
            columns: [
                {
                    title:'操作',
                    attributes: {style: "text-align:center"},
                    command:[{name: "destroy"},
                    ],
                    width:'6%'
                },
                {
                    field: "companyId",
                    title: '公司',
                    attributes: {style: "text-align:center"},
                    width: '12%',
                    editor: function (container, options) {
                        $('<input  required style="width: 180px" type="text" class="k-textbox" validationMessage="只可为非负整数" pattern="^[0-9_]+$" name="' + options.field + '"/>').appendTo(container)
                    },
                },
                {
                    field: "projectId",
                    title: '项目',
                    width: '12%',
                    type:"Decimal",format:"{0:N2}",
                    attributes: {style: "text-align:center"},
                    editor: function (container, options) {
                        if(options.model.gradePriceId !=""){
                            var c = options.model.price;
                            options.model.price = c.toFixed(2);
                            $('<input  required style="width: 180px" type="text" class="k-textbox" validationMessage="只可为非负数" pattern="^([0-9])+(\.[0-9]+)?$" name="' + options.field + '"/>').appendTo(container)
                        }else{
                            $('<input  required style="width: 180px" type="text" class="k-textbox" validationMessage="只可为非负数" pattern="^([0-9])+(\.[0-9]+)?$" name="' + options.field + '"/>').appendTo(container)
                        }
                    },
                },
                {
                    field: "uom",
                    title: '计量单位',
                    attributes: {style: "text-align:center"},
                    width: '12%',
                    template:function (rowdata){
                        for(var k in typeData){
                            if(typeData[k].value == rowdata.uom){
                                return typeData[k].meaning
                            }
                        }
                    },
                    editor: function (container, options) {
                        $('<input type="text" style="width: 120px"class="k-textbox" name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoDropDownList({
                                dataTextField: "meaning",
                                dataValueField:"value",
                                valuePrimitive: true,
                                dataSource: typeData,
                                index:-1,
                            });
                    },
                }
            ],
        }).data("kendoGrid");
        // 自动填充界面
        Hap.autoResizeGrid("#grid");
        // 标题居中
        $("#grid thead>tr th").css("text-align", "center");
    </script>
    </body>