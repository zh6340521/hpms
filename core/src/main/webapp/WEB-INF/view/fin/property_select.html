<#include "../include/header.html">
    <script type="text/javascript">
        var companyId= <#if RequestParameters.companyId?exists>
                         ${RequestParameters.companyId}
                         <#else>-1</#if>;

        var projectId= <#if RequestParameters.projectId?exists>
                       ${RequestParameters.projectId}
                       <#else>-1</#if>;

        var equipmentTypeId= <#if RequestParameters.equipmentTypeId?exists>
                       ${RequestParameters.equipmentTypeId}
                       <#else>-1</#if>;

        console.log(companyId);
        console.log(projectId);
        console.log(equipmentTypeId);

        var viewModel = kendo.observable({
            model: {},
            queryResource: function (e) {
                $('#Grid').data('kendoGrid').dataSource.page(1);
            }
        });
    </script>
    <body>
    <div id="page-content">
        <div id="property_bind_form">
            <form class="form-horizontal" id="pool_form" role="form" style="margin-top: 5px;">
                <div class="row">
                    <div class="from-group col-md-4" style="margin-bottom:10px">
                        <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.propertyname'/></label>
                        <div class="col-md-7">
                            <input type="text" class="k-textbox" name="propertyName"  data-bind="value:model.propertyName" style="width: 90%;">
                        </div>
                    </div>
                    <div class="from-group col-md-4" style="margin-bottom:10px">
                        <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.propertynumber'/></label>
                        <div class="col-md-7">
                            <input type="text" class="k-textbox" name="propertyNumber"  data-bind="value:model.propertyNumber" style="width: 90%;"/>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <script>kendo.bind($('#property_bind_form'), viewModel);</script>

        <div class="pull-left" id="toolbar-btn" style="clear:both;padding-bottom:10px;padding-top:20px;">
            <span   class="btn btn-primary" onclick="linkEquipment()" style="float:left;margin-right:10px;"><@spring.message "关联仪表"/></span>
            <span   data-bind="click:queryResource" class="btn btn-primary" style="float:left;margin-right:10px;"><@spring.message "hap.query"/></span>
        </div>
        <script>kendo.bind($('#toolbar-btn'), viewModel);</script>

        <div style="clear:both">
            <div id="Grid"></div>
        </div>
    </div>

    <div id="equipmentViews" style="display: none"></div>


    <script type="text/javascript">

        var BaseUrl = _basePath;
        dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: BaseUrl + "/hpms/fin/cusmeter/property/query?companyId="+companyId+"&&projectId="+projectId+"&&equipmentTypeId="+equipmentTypeId+"&&configValueName=房间",
                    type: "POST",
                    dataType: "json"
                },
                parameterMap: function (options, type) {
                    if (type !== "read" && options.models) {
                        var datas = Hap.prepareSubmitParameter(options, type)
                        return kendo.stringify(datas);
                    } else if (type === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                    }
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "cusmeterBindId",
                    fields: {}
                }
            }
        });

        var grid = $("#Grid").kendoGrid({
            dataSource : dataSource,
            navigatable: false,
            height     : '100%',
            resizable  : true,
            scrollable : true,
            selectable : "single,rowbox",
            reorderable: true,
            sortable   : true,
            //columnMenu : true, //实现右击可以隐藏显示列
            pageable: {
                pageSizes: [5, 10, 20, 50],
                refresh: true,
                buttonCount: 5
            },
            columns: [
                {
                    field      : "propertyNumber",
                    title      : "<@spring.message 'hpms.mdm.property.propertynumber'/>",
                    width      : 120,
                    attributes : {style: "text-align:center"}
                },{
                    field      : "propertyName",
                    title      : "<@spring.message 'hpms.mdm.property.propertyname'/>",
                    width      : 120,
                    attributes : {style: "text-align:center"}
                },
                {
                    field      : "configValueName",
                    title      : "建筑类型",
                    width      : 120,
                    attributes  : {style: "text-align:center"}
                }
            ],
            editable: false
        }).data("kendoGrid");

        function deleteData() {

            Hap.deleteGridSelection({
                grid: $('#Grid')
            });

        }

        Hap.autoResizeGrid("#Grid");

        function linkEquipment() {
            window.parent.$('#Grid').data('kendoGrid').dataSource.page(1);
            var checked = grid.selectedDataItems();
            if(!checked.length)
            {
                kendo.ui.showInfoDialog({
                    message: $l('hap.tip.selectrow')
                });
                return;
            }else{
                var requestData=[];
                var propertyId;
                $.each(checked,function(i,v){

                    console.log(v.propertyId);
                    propertyId=v.propertyId;
                })

                $("#equipmentViews").kendoWindow({
                    actions: ["Close"],
                    title: $l('关联设备'),
                    draggable: true,
                    height: "550px",
                    width: "750px",
                    content: "${base.contextPath}/fin/property_link_equip.html?companyId="+companyId+"&&projectId="+projectId+"&&equipmentTypeId="+equipmentTypeId+"&&propertyId="+propertyId,
                    iframe: true,
                    modal: true
                });
                var win = $("#equipmentViews").data("kendoWindow");
                win.center().open();
            }


        }




    </script>
    </body>
    </html>