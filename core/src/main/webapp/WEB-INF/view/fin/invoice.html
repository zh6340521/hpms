<#--
        * description: 应付录入
        * version: 1.0
        * #copyright#
        *author: jun.guo@hand-china.com 2017.03.6
        -->
    <#include "../include/header.html">
        <body>
        <style type="text/css">
            .k-textbox {
                width: 180px;
                height: 25px;
            }
            .inputbox{
                width: 180px;
                height: 25px;
            }
        </style>

        <script src="${base.contextPath}/common/code?invoiceClass=HPMS_INVOICE_CLASS" type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?transType=HPMS_TRANS_TYPE" type="text/javascript"></script>
        <script type="text/javascript">




            var viewModel = kendo.observable({
                model: {},
                invoiceId:{}
            });
            var newViewModel = kendo.observable({
                model: {},
                invoiceClassData:invoiceClass,
                transTypeData:transType
            });

            $(document).ready(function(){
                var makeDate=null;
                makeDate=new Date();
                var seperator1 = "-";
                var year = makeDate.getFullYear();
                var month = makeDate.getMonth() + 1;
                var strDate = makeDate.getDate();
                if (month >= 1 && month <= 9) {
                    month = "0" + month;
                }
                if (strDate >= 0 && strDate <= 9) {
                    strDate = "0" + strDate;
                }
                var currentdate = year + seperator1 + month + seperator1 + strDate;
                document.getElementById("makeDate").innerText=currentdate;

                $('#saveForm').hide();
                $('#selectRoom').attr("disabled", true);
            });


        </script>
        <div id="property_tree" ></div>
        <div id="page-content">
            <div id="dialogNewData"></div>
            <div id="property_form">
                <form class="form-horizontal" id="pool_form" role="form" style="margin-top: 5px;">
                    <div class="row">
                        <div style="margin-bottom:10px;margin-right:5%;float: right">
                                <label><@spring.message '制单日期'/>:</label>
                                <span id="makeDate"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.company'/></label>
                            <div class="col-md-7">
                                <input id="companyId" name="companyId" data-bind="value:model.companyId" style="width: 90%;"/>
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.project'/></label>
                            <div class="col-md-7">
                                <input id="projectId" name="projectId" data-bind="value:model.projectId" style="width: 90%;"/>
                            </div>
                        </div>

                    </div>
                    <div class="row">
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.invoiceType'/></label>
                            <div class="col-md-7">
                                <input  id="invoiceType" name="invoiceType"  data-bind="value:model.invoiceType" style="width: 90%;"/>
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.invoiceDate'/></label>
                            <div class="col-md-7">
                                <input id="invoiceDate" class="k-datepicker" name="invoiceDate"  data-bind="value:model.invoiceDate" style="width: 90%;"/>
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.invoiceNum'/></label>
                            <div class="col-md-7">
                                <input type="text" class="k-textbox" data-bind="value:model.invoiceNum" style="width: 90%;"/>
                            </div>
                        </div>
                    </div>
                    <div class="row">

                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <div class="col-md-2 control-label" style="text-align: right">
                                <button id="selectRoom" type="button" class="btn btn-default btn-xs" data-toggle="tooltip" data-placement="top" title=选择房间" onclick="newTree()" ><span class="fa fa-bank"></span></button>
                            </div>

                            <label class="col-md-3 control-label"><@spring.message 'hpms.mdm.property.propertynumber'/></label>
                            <div class="col-md-7">
                                <input disabled="disabled" style="background: #DDDDDD;width: 90%;" type="text" class="k-textbox" name="propertyNumber"  data-bind="value:model.propertyNumber"/>
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.propertyname'/></label>
                            <div class="col-md-7">
                                <input disabled="disabled" style="background: #DDDDDD;width: 90%;" type="text" class="k-textbox" name="propertyName"  data-bind="value:model.propertyName" />
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.customer.customername'/></label>
                            <div class="col-md-7">
                                <input disabled="disabled" style="background: #DDDDDD;width: 90%;" type="text" class="k-textbox" data-bind="value:model.customerName"/>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.accountdate'/></label>
                            <div class="col-md-7">
                                <input id="accountDate" name="accountDate"  data-bind="value:model.accountDate" style="width: 90%;"/>
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.accountperiod'/></label>
                            <div class="col-md-7">
                                <input type="text" class="k-textbox" disabled="disabled" name="accountPeriod"  data-bind="value:model.accountPeriod" style="width: 90%;background: #DDDDDD"/>
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.transtype'/></label>
                            <div class="col-md-7">
                                <input id="transType" name="transType" data-bind="value:model.transType" style="width: 90%;"/>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.paymentterm'/></label>
                            <div class="col-md-7">
                                <input id="paymentTerm" name="paymentTerm"   name="paymentTerm"  data-bind="value:model.paymentTermId" style="width: 90%;"/>
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.paymentmethod'/></label>
                            <div class="col-md-7">
                                <input id="paymentMethod" name="paymentMethod"  data-bind="value:model.paymentMethodId" style="width: 90%;"/>
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.taxamount'/></label>
                            <div class="col-md-7">
                                <input disabled="disabled" type="text" class="k-textbox" name="taxAmount" data-bind="value:model.taxAmount" style="width: 90%;background: #DDDDDD"/>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.invoiceamount'/></label>
                            <div class="col-md-7">
                                <input type="text" id="invoiceamount" class="k-textbox" name="invoiceAmount"  data-bind="value:model.invoiceAmount" style="width: 90%;"/>
                            </div>
                        </div>
                        <div class="from-group col-md-4" style="margin-bottom:10px">
                            <label class="col-md-5 control-label"><@spring.message 'hpms.fin.invoice.balance'/></label>
                            <div class="col-md-7">
                                <input disabled="disabled" type="text" class="k-textbox" name="balance"  data-bind="value:model.balance" style="width: 90%;background: #DDDDDD"/>
                            </div>
                        </div>

                    </div>

                </form>
            </div>
            <script>kendo.bind($('#property_form'), newViewModel);</script>
            <span id="saveForm" class="btn btn-success k-grid-save-changes"
                  style="float:right;margin-right:40px;margin-top: -40px;"
                  onclick="submitInvoiceHeader()"><i class="fa fa-save" style="margin-right:3px;"></i>保存</span>
            <script>kendo.bind($('#saveForm'), newViewModel);</script>
            <div style="clear:both">
                <div id="invoice_grid" ></div>
            </div>
            <!--<script>kendo.bind($('#invoice_grid'), viewModel);</script>-->
        </div>
        <script type="text/javascript" >


            $('#property_form input').keydown(function (e) {
                if (e.keyCode == 13) {
                    e.target.blur();
                    viewModel.queryResource(e);
                }
            });

            $("#companyId").kendoComboBox({
                valuePrimitive: true,
                dataTextField: "companyFullName",
                dataValueField: "companyId",
                dataSource: {
                    transport: {
                        read:function(options) {
                            $.ajax({
                                type   : "POST",
                                url: "${base.contextPath}/mdm/property/companyQuery",
                                data: {},
                                success: function(json) {
                                    options.success(json.rows);
                                }
                            });
                        }
                    }
                },change:function () {

                    if(newViewModel.model.companyId==null||newViewModel.model.projectId==undefined
                            ||newViewModel.model.companyId==undefined||newViewModel.model.projectId==null){
                        document.getElementById("selectRoom").disabled=true;
                    }else{
                        document.getElementById("selectRoom").disabled=false;
                    }
                }
            });
            $("#projectId").kendoComboBox({
                autoBind: false,
                valuePrimitive: true,
                cascadeFrom: "companyId",
                cascadeFromField: "companyId",
                filter: "contains",
                dataTextField: "projectName",
                dataValueField: "projectId",
                dataSource: {
                    serverFiltering:true,
                    transport: {
                        read: {
                            url:"${base.contextPath}/mdm/property/projectQuery",
                            type : "POST"
                        },
                        contentType : "application/json",
                        parameterMap: function(options, type) {
                            if (type === "read") {
                                var filter = options.filter.filters[0]
                                var map = {};
                                map[filter.field] = filter.value;
                                return map;
                            }
                        }
                    },
                    schema: {
                        data: 'rows'
                    }
                },change:function () {

                    if(newViewModel.model.companyId==null||newViewModel.model.projectId==undefined
                            ||newViewModel.model.companyId==undefined||newViewModel.model.projectId==null){
                        document.getElementById("selectRoom").disabled=true;
                    }else{
                        document.getElementById("selectRoom").disabled=false;
                    }
                }

            }) ;

            $("#invoiceType").kendoDropDownList({

                optionLabel: "--请选择--",
                dataTextField: "meaning",
                template: function(dataItem){
                    return dataItem['meaning'] || ''
                },
                dataValueField: "value",
                dataSource: invoiceClass,
                select : function(e){
                    var dataItem = this.dataItem(e.item);
                    newViewModel.model.set('invoiceType',dataItem.value);
                }

            }).data("kendoDropDownList");

            $("#invoiceDate").kendoDatePicker({
                format: "yyyy-MM-dd"
            }).data("kendoDatePicker");


            $("#accountDate").kendoDatePicker({
                format: "yyyy-MM-dd",
                change:function () {
                    if(newViewModel.model.accountDate==null){
                        newViewModel.model.set('accountPeriod',null);
                    }else{
                       // console.log(newViewModel.model.accountDate);
                        var time=newViewModel.model.accountDate;
                        var seperator1 = "-";
                        var year = time.getFullYear();
                        var month = time.getMonth() + 1;

                        if (month >= 1 && month <= 9) {
                            month = "0" + month;
                        }
                        var currentdate = year + seperator1 + month;
                        newViewModel.model.set('accountPeriod',currentdate);
                    }
                    //newViewModel.model.set('accountPeriod',newViewModel.model.accountDate.substring(0,7));
                }

            }).data("kendoDatePicker");

           /* document.getElementById('accountDate').onblur=function(){
                //console.log(this.value);
                newViewModel.model.set('accountPeriod',this.value.substring(0,7));
            }
*/
            document.getElementById("companyId").onblur=function(){
               // console.log(newViewModel.model.companyId);
                //console.log(newViewModel.model.projectId);
                if(newViewModel.model.companyId==null||newViewModel.model.projectId==undefined
                        ||newViewModel.model.companyId==undefined||newViewModel.model.projectId==null){
                    document.getElementById("selectRoom").disabled=true;
                }else{
                    document.getElementById("selectRoom").disabled=false;
                }
            }
            document.getElementById("projectId").onblur=function(){
                //console.log(newViewModel.model.companyId);
               // console.log(newViewModel.model.projectId);
                if(newViewModel.model.companyId==null||newViewModel.model.projectId==undefined
                        ||newViewModel.model.companyId==undefined||newViewModel.model.projectId==null){
                    document.getElementById("selectRoom").disabled=true;
                }else{
                    document.getElementById("selectRoom").disabled=false;
                }
            }

            document.getElementById('invoiceamount').onblur=function(){
                var curbalance=newViewModel.model.curbalance;
                if(parseFloat(this.value)>parseFloat(curbalance)){
                    kendo.ui.showInfoDialog({
                        message : '<@spring.message "超出范围"/>'
                    });
                    newViewModel.model.set('invoiceAmount',null);
                }else{
                    newViewModel.model.set('balance',-(parseFloat(curbalance)-parseFloat(this.value)));
                }
            }


            $("#transType").kendoDropDownList({

                optionLabel: "--请选择--",
                dataTextField: "meaning",
                template: function(dataItem){
                    return dataItem['meaning'] || ''
                },
                dataValueField: "value",
                dataSource: transType,
                select : function(e){
                    var dataItem = this.dataItem(e.item);
                    newViewModel.model.set('transType',dataItem.value);
                }

            }).data("kendoDropDownList");



            $("#paymentMethod").kendoComboBox({
                valuePrimitive: true,
                dataTextField: "paymentMethodName",
                dataValueField: "paymentMethodId",
                dataSource: {
                    transport: {
                        read:function(options) {
                            $.ajax({
                                type   : "POST",
                                url: "${base.contextPath}/mdm/paymentMethod/paymentMethodQuery",
                                data: {},
                                success: function(json) {
                                    options.success(json.rows);
                                }
                            });
                        }
                    }
                }
            });


            $("#paymentMethod").kendoComboBox({
                valuePrimitive: true,
                dataTextField: "paymentMethodName",
                dataValueField: "paymentMethodId",
                dataSource: {
                    transport: {
                        read:function(options) {
                            $.ajax({
                                type   : "POST",
                                url: "${base.contextPath}/mdm/paymentMethod/paymentMethodQuery",
                                data: {},
                                success: function(json) {
                                    options.success(json.rows);
                                }
                            });
                        }
                    }
                }
            });



            $("#paymentTerm").kendoComboBox({
                valuePrimitive: true,
                dataTextField: "paymentTermName",
                dataValueField: "paymentTermId",
                dataSource: {
                    transport: {
                        read:function(options) {
                            $.ajax({
                                type   : "POST",
                                url: "${base.contextPath}/mdm/paymentTerm/paymentTermQuery",
                                data: {},
                                success: function(json) {
                                    options.success(json.rows);
                                }
                            });
                        }
                    }
                }
            });

            var invoiceId=null;
            invoiceId=-1;
            var dataSource = new kendo.data.DataSource({
                transport   : {
                    read        : {
                        url     : _basePath+"/hpms/fin/invoice/line/query?invoiceId="+invoiceId,
                        type    : "POST",
                        dataType: "json"
                    },
                    parameterMap: function (options, type) {
                        if (type !== "read" && options.models) {
                            var datas = Hap.prepareSubmitParameter(options, type)
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);

                        }
                    }
                },
                batch       : true,
                serverPaging: true,
                pageSize    : 10,
                schema      : {
                    data  : 'rows',
                    total : 'total',
                    model : {
                        id    : "invoiceLineId",
                        fields: {
                            invoiceId:{

                            },
                            lineNumner:{

                            },
                            feeName:{

                            },
                            feeId:{

                            },
                            accountNum:{

                            },
                            costCenter:{

                            },
                            profitCenter:{

                            },
                            lineAmount:{

                            },
                            taxCode:{

                            },
                            taxAmount:{

                            },
                            description:{

                            }

                        }
                    }
                }
            });
           var grid = $("#invoice_grid").kendoGrid({
                dataSource : dataSource,
                navigatable: false,
                height     : '100%',
                resizable  : true,
                scrollable : true,
                selectable : 'row',
                reorderable: true,
                pageable   : {
                    pageSizes  : [5, 10, 20, 50],
                    refresh    : true,
                    buttonCount: 5
                },
                toolbar   : [{
                   template : '<span onclick="createFunction()" class="btn btn-primary">新建</span>'
                }],
               columns    : [{
                    field      : "lineNumner",
                    title      : "<@spring.message 'hpms.fin.invoice.lineNumber'/>",
                    width      : 80,
                    attributes  : {style: "text-align:center"},
                   /* template: function(dataItem) {
                        //console.log(dataItem['lineNumner']);
                        return dataItem['lineNumner']||'';
                    },
                    editor: function(container, options){
                            container.html(options.model.lineNumner);
                            container.removeClass('k-edit-cell');
                    }*/
                   template: "<span class='row-number'></span>",
                   width:45,
                   locked: true,
                   lockable: false

               },{
                    field      : "feeName",
                    title      : "<@spring.message 'hpms.fin.invoice.feeName'/>",
                    width      : 120,
                    attributes  : {style: "text-align:center"},
                    template:function(dataItem) {
                        return dataItem['feeName']||'';
                    },
                    editor: function(container, options){

                        if (options.model.invoiceLineId != "") {
                            container.html(options.model.feeName);
                            container.removeClass('k-edit-cell');
                        }else {
                            $('<input required validationMessage="必输" name="' + options.field + '"/>')
                                    .appendTo(container)
                                    .kendoDropDownList({
                                        dataTextField: "feeName",
                                        dataValueField: "feeName",
                                        valuePrimitive: true,
                                        dataSource:  {
                                            transport: {
                                                read:function(options) {
                                                    $.ajax({
                                                        type   : "POST",
                                                        url: "/hpms/mdm/fee/query?enableFlag="+'Y',
                                                        data: {},
                                                        success: function(json) {
                                                            options.success(json.rows);
                                                        }
                                                    });
                                                }
                                            }
                                        },
                                        select : function(e){
                                            var dataItem = this.dataItem(e.item);
                                            options.model.set('feeName',dataItem.feeName);
                                            options.model.set('feeId',dataItem.feeId);
                                        }
                                    });
                        }
                    }

                },{
                    field      : "accountNum",
                    title      : "<@spring.message 'hpms.fin.invoice.accountNum'/>",
                    width      : 120,
                    attributes : {style: "text-align:center"},
                    template:function(dataItem) {
                       return dataItem['accountNum']||'';
                    },
                    editor: function(container, options){

                       if (options.model.invoiceLineId != "") {
                           container.html(options.model.accountNum);
                           container.removeClass('k-edit-cell');
                       }else {
                           var editor = $('<input type="text" name="accountNum" class="k-input k-textbox">');
                           editor.css('width','100%');
                           container.append(editor);
                       }
                   }
                },{
                    field      : "costCenter",
                    title      : "<@spring.message 'hpms.fin.invoice.costCenter'/>",
                    width      : 120,
                    attributes : {style: "text-align:center"},
                    template:function(dataItem) {
                       return dataItem['costCenter']||'';
                    },
                    editor: function(container, options){

                       if (options.model.invoiceLineId != "") {
                           container.html(options.model.costCenter);
                           container.removeClass('k-edit-cell');
                       }else {
                           var editor = $('<input type="text" name="costCenter" class="k-input k-textbox">');
                           editor.css('width','100%');
                           container.append(editor);
                       }
                    }

                },{
                    field      : "profitCenter",
                    title      : "<@spring.message 'hpms.fin.invoice.profitCenter'/>",
                    width      : 120,
                    attributes  : {style: "text-align:center"},
                    template:function(dataItem) {
                       return dataItem['profitCenter']||'';
                    },
                    editor: function(container, options){

                       if (options.model.invoiceLineId != "") {
                           container.html(options.model.profitCenter);
                           container.removeClass('k-edit-cell');
                       }else {
                           var editor = $('<input type="text" name="profitCenter" class="k-input k-textbox">');
                           editor.css('width','100%');
                           container.append(editor);
                       }
                    }

                },{
                    field      : "lineAmount",
                    title      : "<@spring.message 'hpms.fin.invoice.lineAmount'/>",
                    width      : 100,
                    attributes  : {style: "text-align:center"},
                    template:function(dataItem) {
                       return dataItem['lineAmount']||'';
                    },
                    editor: function(container, options){

                       if (options.model.invoiceLineId != "") {
                           container.html(options.model.lineAmount);
                           container.removeClass('k-edit-cell');
                       }else {
                           var editor = $('<input type="text" name="lineAmount" class="k-input k-textbox">');
                           editor.css('width','100%');
                           container.append(editor);
                       }
                    }
                },{
                    field      : "taxCode",
                    title      : "<@spring.message 'hpms.fin.invoice.taxCode'/>",
                    width      : 100,
                    attributes  : {style: "text-align:center"},
                    template:function(dataItem) {
                       return dataItem['taxCode']||'';
                    },
                    editor: function(container, options){

                       if (options.model.invoiceLineId != "") {
                           container.html(options.model.taxCode);
                           container.removeClass('k-edit-cell');
                       }else {
                           var editor = $('<input type="text" name="taxCode" class="k-input k-textbox">');
                           editor.css('width','100%');
                           container.append(editor);
                       }
                    }
                },{
                    field      : "taxAmount",
                    title      : "<@spring.message 'hpms.fin.invoice.taxAmount'/>",
                    width      : 100,
                    attributes  : {style: "text-align:center"},
                    template:function(dataItem) {
                       return dataItem['taxAmount']||'';
                    },
                    editor: function(container, options){

                       if (options.model.invoiceLineId != "") {
                           container.html(options.model.taxAmount);
                           container.removeClass('k-edit-cell');
                       }else {
                           var editor = $('<input type="text" name="taxAmount" class="k-input k-textbox">');
                           editor.css('width','100%');
                           container.append(editor);
                       }
                    }
                },{
                    field      : "description",
                    title      : "备注",
                    width      : 120,
                    attributes  : {style: "text-align:center"},
                    template:function(dataItem) {
                       return dataItem['description']||'';
                    },
                    editor: function(container, options){

                       if (options.model.invoiceLineId != "") {
                           container.html(options.model.description);
                           container.removeClass('k-edit-cell');
                       }else {
                           var editor = $('<input type="text" name="description" class="k-input k-textbox">');
                           editor.css('width','100%');
                           container.append(editor);
                       }
                    }
                },{
                    title: '操作',
                    width : 100,
                    attributes : {
                        style : "text-align:center"
                    },

                    template : function(rowdata) {
                        var uid = rowdata.uid.toString();

                        if(rowdata.invoiceLineId==null||rowdata.invoiceLineId==''){
                            var singleDispatch = '<button type="button" class="btn btn-primary btn-xs" data-toggle="tooltip" data-placement="top" title='+'查看'+' onclick="submitInvoiceLine()"><span>插入</span></button>';
                            return singleDispatch;
                        }else{
                            var singleDispatch = '<button type="button" disabled="disabled" class="btn btn-primary btn-xs" data-toggle="tooltip" data-placement="top" title='+'查看'+' onclick=" "><span>已插入</span></button>';
                            return singleDispatch;
                        }
                    }
                }],
               editable: {
                   createAt:"bottom"
               },
               dataBound: function(e) {
                   var view = this.dataSource.view();
                   this.items().each(function (index, row) {
                       kendo.bind(row, view[index]);
                   });
                   var rows = this.items();
                   $(rows).each(function () {
                       var index =(dataSource._page-1)*dataSource._pageSize+$(this).index() + 1;
                       var rowLabel = $(this).find(".row-number");
                       $(rowLabel).html(index);
                   });
               }



           }).data("kendoGrid");
            $("#invoice_grid thead>tr th").css("text-align","center");
            Hap.autoResizeGrid("#invoice_grid");

            function newTree(){

                if(newViewModel.model.companyId==null||newViewModel.model.projectId==null){
                        $('#selectRoom').attr("disabled", true);
                    }else{
                        $('#selectRoom').removeAttr("disabled");
                }


                $("#property_tree").kendoWindow({
                    actions: ["Close"],
                    title: $l('选择'),
                    draggable: true,
                    height: "400px",
                    width: "510px",
                    content: '${base.contextPath}/fin/invoice_queryOccupation.html?companyId='+newViewModel.model.companyId+'&projectId='+newViewModel.model.projectId,
                    iframe: true,
                    modal: true
                });
                var win = $("#property_tree").data("kendoWindow");
                win.center().open();
            }


            function createFunction(){
                $('#invoice_grid').data('kendoGrid').addRow();
            }


            var dataSource1;
            function submitInvoiceLine() {
                if(dataSource1==null){
                    var items=dataSource.data();

                    //items[items.length-2].
                    if(items.length==1){
                        viewModel.model.set('lineNumner',1);
                    }else{
                        viewModel.model.set('lineNumner',items[items.length-2].lineNumner+1);
                        viewModel.model.set('invoiceId',items[items.length-2].invoiceId);
                    }

                    //viewModel.model.set('invoiceId',items[items.length-2].invoiceId);
                    viewModel.model.set('feeId',items[items.length-1].feeId);
                    viewModel.model.set('accountNum',items[items.length-1].accountNum);
                    viewModel.model.set('costCenter',items[items.length-1].costCenter);
                    viewModel.model.set('profitCenter',items[items.length-1].profitCenter);
                    viewModel.model.set('lineAmount',items[items.length-1].lineAmount);
                    viewModel.model.set('taxCode',items[items.length-1].taxCode);
                    viewModel.model.set('taxAmount',items[items.length-1].taxAmount);
                    viewModel.model.set('description',items[items.length-1].description);
                    //newViewModel.model.set('occupationId',10017);
                    //newViewModel.model.set('payableCode',"A01YF201703020023");
                    newViewModel.model.set('curbalance',items[items.length-1].lineAmount);
                    newViewModel.model.set('balance',-(items[items.length-1].lineAmount));
                    newViewModel.model.set('taxAmount',(items[items.length-1].taxAmount));
                    newViewModel.model.set('invoiceAmount',0);

                    if(items.length==1){
                        var invoiceLineMessage = kendo.stringify(viewModel.model);
                        var invoiceHeaderMessage=kendo.stringify(newViewModel.model);
                        var jsonInvoiceHeader=JSON.parse(invoiceHeaderMessage);
                        var json = JSON.parse(invoiceLineMessage);

                        json.invoice=jsonInvoiceHeader;

                    }else{
                        var invoiceLineMessage = kendo.stringify(viewModel.model);

                        var json = JSON.parse(invoiceLineMessage);

                    }
                }else{
                    var items=dataSource1.data();

                    //items[items.length-2].
                    if(items.length==1){
                        viewModel.model.set('lineNumner',1);
                    }else{
                        viewModel.model.set('lineNumner',items[items.length-2].lineNumner+1);
                        viewModel.model.set('invoiceId',items[items.length-2].invoiceId);
                    }
                    var balance=0;
                    var taxAmount=0;
                    for(var i=0;i<items.length;i++){
                        balance=parseFloat(items[i].lineAmount)+balance;
                        taxAmount=parseFloat(items[i].taxAmount)+taxAmount;
                    }

                    newViewModel.model.set('curbalance',balance);

                    newViewModel.model.set('balance',-balance);
                    newViewModel.model.set('taxAmount',taxAmount);
                    newViewModel.model.set('invoiceAmount',0);

                    viewModel.model.set('feeId',items[items.length-1].feeId);
                    viewModel.model.set('accountNum',items[items.length-1].accountNum);
                    viewModel.model.set('costCenter',items[items.length-1].costCenter);
                    viewModel.model.set('profitCenter',items[items.length-1].profitCenter);
                    viewModel.model.set('lineAmount',items[items.length-1].lineAmount);
                    viewModel.model.set('taxCode',items[items.length-1].taxCode);
                    viewModel.model.set('taxAmount',items[items.length-1].taxAmount);
                    viewModel.model.set('description',items[items.length-1].description);


                    if(items.length==1){
                        var invoiceLineMessage = kendo.stringify(viewModel.model);
                        var invoiceHeaderMessage=kendo.stringify(newViewModel.model);
                        var jsonInvoiceHeader=JSON.parse(invoiceHeaderMessage);
                        var json = JSON.parse(invoiceLineMessage);

                        json.invoice=jsonInvoiceHeader;

                    }else{
                        var invoiceLineMessage = kendo.stringify(viewModel.model);
                        var invoiceHeaderMessage=kendo.stringify(newViewModel.model);
                        var jsonInvoiceHeader=JSON.parse(invoiceHeaderMessage);
                        var json = JSON.parse(invoiceLineMessage);

                        json.invoice=jsonInvoiceHeader;

                    }
                }


                $.ajax({
                    url: "${base.contextPath}/hpms/fin/invoice/line/submit",
                    type:"POST",
                    dataType:"json",
                    contentType:"application/json",
                    data:  kendo.stringify(json),
                    success: function(data){


                        if (data.success) {
                            //viewModel.model.set('invoiceId',data.rows[0].invoiceId);
                            //console.log(data.rows[0].invoiceId);
                            invoiceId=data.rows[0].invoiceId;
                            dataSource1 = new kendo.data.DataSource({
                                transport   : {
                                    read        : {
                                        url     : _basePath+"/hpms/fin/invoice/line/query?invoiceId="+invoiceId,
                                        type    : "POST",
                                        dataType: "json"
                                    },
                                    parameterMap: function (options, type) {
                                        if (type !== "read" && options.models) {
                                            var datas = Hap.prepareSubmitParameter(options, type)
                                            return kendo.stringify(datas);
                                        } else if (type === "read") {
                                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);

                                        }
                                    }
                                },
                                batch       : true,
                                serverPaging: true,
                                pageSize    : 10,
                                schema      : {
                                    data  : 'rows',
                                    total : 'total',
                                    model : {
                                        id    : "invoiceLineId",
                                        fields: {
                                            invoiceId:{

                                            },
                                            lineNumner:{

                                            },
                                            feeName:{

                                            },
                                            feeId:{

                                            },
                                            accountNum:{

                                            },
                                            costCenter:{

                                            },
                                            profitCenter:{

                                            },
                                            lineAmount:{

                                            },
                                            taxCode:{

                                            },
                                            taxAmount:{

                                            },
                                            description:{

                                            }

                                        }
                                    }
                                }
                            });
                            $('#invoice_grid').data('kendoGrid').setDataSource(dataSource1);
                            $('#invoice_grid').data('kendoGrid').dataSource.page(1);
                            $('#saveForm').show();
                            kendo.ui.showInfoDialog({
                                message : '<@spring.message "hap.tip.success"/>'
                            });

                        } else {
                            kendo.ui.showInfoDialog({
                                message : data.message
                            });
                        }
                    }});

            }
            
            function submitInvoiceHeader() {

                if(newViewModel.model.balance!=0){
                    kendo.ui.showInfoDialog({
                        message : '<@spring.message "修改应付总额"/>'
                    });
                }else{
                    if(dataSource1==null){
                        var items=dataSource.data();
                        newViewModel.model.set('invoiceId',items[0].invoiceId);
                        var invoiceHeaderMessage=kendo.stringify(newViewModel.model);
                        var jsonInvoiceHeader=JSON.parse(invoiceHeaderMessage);

                    }else{
                        var items=dataSource1.data();
                        newViewModel.model.set('invoiceId',items[0].invoiceId);
                        var invoiceHeaderMessage=kendo.stringify(newViewModel.model);
                        var jsonInvoiceHeader=JSON.parse(invoiceHeaderMessage);
                    }


                    $.ajax({
                        url: "${base.contextPath}/hpms/fin/invoice/submit",
                        type:"POST",
                        dataType:"json",
                        contentType:"application/json",
                        data:  kendo.stringify(jsonInvoiceHeader),
                        success: function(data){
                            if (data.success) {
                                kendo.ui.showInfoDialog({
                                    message : '<@spring.message "hap.tip.success"/>'
                                });
                            } else {
                                kendo.ui.showInfoDialog({
                                    message : data.message
                                });
                            }
                        }});
                }



            }



        </script>
        </body>
        </html>