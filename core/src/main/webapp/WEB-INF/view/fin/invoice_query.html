<#include "../include/header.html">

    <body>
    <script src="${base.contextPath}/common/code?roundRule=HPMS_ROUND_RULE" type="text/javascript"></script>
    <script src="${base.contextPath}/common/code?billMethod=HPMS_BILL_METHOD" type="text/javascript"></script>
    <script src="${base.contextPath}/common/code?transType=HPMS_TRANS_TYPE" type="text/javascript"></script>
    <script src="${base.contextPath}/common/code?billingFreq=HPMS_BILLING_FREQ" type="text/javascript"></script>
    <script src="${base.contextPath}/common/code?enableFlag=MDM.ENABLE_FLAG" type="text/javascript"></script>
    <script type="text/javascript">

        var viewModel = kendo.observable({
            model: {},
            queryResource: function (e) {
                $('#Grid').data('kendoGrid').dataSource.page(1);
            }
        });

        var newViewModel = kendo.observable({
            model: {}
        });
    </script>
    <div id="content-container">
        <div id="page-content">
            <div id="property_form" class="panel" style="padding: 0px;border:none;box-shadow: none;">
                <form class="form-horizontal" id="query-form">
                    <div class="panel-body">
                        <div class="row">
                            <div class="from-group col-md-6" style="margin-bottom:10px">
                                <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.company'/></label>
                                <div class="col-md-5">
                                    <input id="companyId" name="companyId" data-bind="value:model.companyId" style="width: 90%;"/>
                                </div>
                            </div>
                            <div class="from-group col-md-6" style="margin-bottom:10px">
                                <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.project'/></label>
                                <div class="col-md-5">
                                    <input id="projectId" name="projectId" data-bind="value:model.projectId" style="width: 90%;"/>
                                </div>
                            </div>
                        </div>


                        <div class="row">
                            <div class="from-group col-md-6" style="margin-bottom:10px">
                                <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.customer.customername'/></label>
                                <div class="col-md-5">
                                    <input type="text" class="k-textbox" data-bind="value:model.customerName" style="width: 90%;"/>
                                </div>
                            </div>
                            <div class="from-group col-md-6" style="margin-bottom:10px">
                                <label class="col-md-5 control-label"><@spring.message 'hpms.mdm.property.propertyname'/></label>
                                <div class="col-md-5">
                                    <input type="text" class="k-textbox" data-bind="value:model.propertyName" style="width: 90%;"/>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>

            </div>

            <script>kendo.bind($('#property_form'), viewModel);</script>

            <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                <span class="btn btn-primary" style="float:left;width:70px;margin-right:5px;" data-bind="click:queryResource" type="submit"><i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
            </div>
            <script>kendo.bind($('#toolbar-btn'), viewModel);</script>

            <div style="clear:both">
                <div id="Grid"></div>
            </div>
        </div>

    </div>

    <div id="lookWin" style="display: none"></div>
    <script type="text/javascript">
        $('#query-form input').keydown(function (e) {
            if (e.keyCode == 13) {
                e.target.blur();
                viewModel.queryResource(e);
            }
        });

        $("#companyId").kendoComboBox({
            valuePrimitive: true,
            dataTextField: "companyFullName",
            dataValueField: "companyId",
            dataSource: {
                transport: {
                    read:function(options) {
                        $.ajax({
                            type   : "POST",
                            url: "${base.contextPath}/mdm/property/companyQuery",
                            data: {},
                            success: function(json) {
                                options.success(json.rows);
                            }
                        });
                    }
                }
            }
        });
        $("#projectId").kendoComboBox({
            autoBind: false,
            valuePrimitive: true,
            cascadeFrom: "companyId",
            cascadeFromField: "companyId",
            filter: "contains",
            dataTextField: "projectName",
            dataValueField: "projectId",
            dataSource: {
                serverFiltering:true,
                transport: {
                    read: {
                        url:"${base.contextPath}/mdm/property/projectQuery",
                        type : "POST"
                    },
                    contentType : "application/json",
                    parameterMap: function(options, type) {
                        if (type === "read") {
                            var filter = options.filter.filters[0]
                            var map = {};
                            map[filter.field] = filter.value;
                            return map;
                        }
                    }
                },
                schema: {
                    data: 'rows'
                }
            }

        }) ;



    </script>



    <script type="text/javascript">

        var BaseUrl = _basePath;
        dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: BaseUrl + "/hpms/fin/invoice/query",
                    type: "POST",
                    dataType: "json"
                },
                parameterMap: function (options, type) {
                    if (type !== "read" && options.models) {
                        var datas = Hap.prepareSubmitParameter(options, type)
                        return kendo.stringify(datas);
                    } else if (type === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                    }
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "invoiceId",
                    fields: {
                        meaning1:{

                        },
                        meaning2:{

                        }

                    }
                }
            }
        });

        $("#Grid").kendoGrid({
            dataSource: dataSource,
            height: '100%',
            resizable: true,
            scrollable: true,
            navigatable: false,
            columnMenu		: 	true,
            autoBind		: 	true,
            reorderable	: 	true,
            pageable: {
                pageSizes: [5, 10, 20, 50],
                refresh: true,
                buttonCount: 5
            },
            columns: [
                {
                    title: '操作栏',
                    width : 60,
                    locked: true,
                    lockable: false,
                    attributes : {
                        style : "text-align:center"
                    },
                    template : function(rowdata) {
                        var uid = rowdata.uid.toString();
                        var singleDispatch = '<button type="button" id="lookFee" class="btn btn-default btn-xs" data-toggle="tooltip" data-placement="top" title='+'<@spring.message "hap.view"/>'+' onclick="lookFee('+rowdata.invoiceId+')"><span class="fa fa-search"></span></button>&nbsp;';
                        return singleDispatch;
                    }
                },
                {
                    field: "payableCode",
                    title: '<@spring.message "hpms.fin.invoice.payablecode"/>',
                    width: 150
                },
                {
                    field: "invoiceNum",
                    title: '<@spring.message "hpms.fin.invoice.invoicenum"/>',
                    width: 120
                },
                {
                    field: "invoiceDate",
                    title: '<@spring.message "hpms.fin.invoice.invoiceDate"/>',
                    width: 100
                },

                {
                    field: "meaning1",
                    title: '<@spring.message "hpms.fin.invoice.invoiceType"/>',
                    width: 100

                },
                {
                    field: "propertyName",
                    title: '<@spring.message "hpms.mdm.property.propertyname"/>',
                    width: 100
                },
                {
                    field: "customerName",
                    title: '<@spring.message "hpms.mdm.customer.customername"/>',
                    width: 80
                },
                {
                    field: "meaning2",
                    title: '<@spring.message "hpms.fin.invoice.transtype"/>',
                    width: 80
                },
                {
                    field: "paymentMethodName",
                    title: '<@spring.message "hpms.fin.invoice.paymentmethod"/>',
                    width: 80
                },
                {
                    field: "paymentTermName",
                    title: '<@spring.message "hpms.fin.invoice.paymentTerm"/>',
                    width: 80
                },
                {
                    field: "invoiceAmount",
                    title: '<@spring.message "hpms.fin.invoice.invoiceAmount"/>',
                    width: 80,
                    attributes: {style: "text-align:center"}
                },
                {
                    field: "taxAmount",
                    title: '<@spring.message "hpms.fin.invoice.taxAmount"/>',
                    width: 80,
                    attributes: {style: "text-align:center"}
                }

            ],
            editable: false
        });

        Hap.autoResizeGrid("#Grid");


        function lookFee(invoiceId){
            //console.log(feeId);
            $("#lookWin").kendoWindow({
                actions: ["Close"],
                title: $l('应付发票明细'),
                draggable: true,
                height: "350px",
                width: "980px",
                close: function(){
                    $("#editWin").empty();
                },
                content: "${base.contextPath}/fin/invoiceLines_query.html?islook=1&&invoiceId="+invoiceId,
                iframe: true,
                modal: true
            });
            var win = $("#lookWin").data("kendoWindow");
            win.center().open();
        }

    </script>
    </body>
    </html>