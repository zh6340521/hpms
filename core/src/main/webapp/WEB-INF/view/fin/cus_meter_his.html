<#--
        * description: 客户仪表抄表记录
        * version: 1.0
        * #copyright#
        * author jun.guo@hand-china.com    2017/3/21 10:20:00
        -->
    <#include "../include/header.html">
        <script type="text/javascript">
            var viewModel = kendo.observable({
                model: {},
                createFunction: function () {
                    $('#Grid').data('kendoGrid').addRow();
                },
                saveFunction: function () {
                    $('#Grid').data('kendoGrid').saveChanges();
                },
                queryResource: function (e) {
                    $('#Grid').data('kendoGrid').dataSource.page(1);
                }
            });

        </script>
        <body>
        <style>
            #progressBar {
                display: block;
                width: 60%;
                margin: auto;
                margin-top: 256.6px;
            }

            #exams {
                display: none;
                position: absolute;
                top: 0px;
                left: 0px;
                right: 0px;
                bottom: 0px;
                background: #fff;
                filter: alpha(opacity = 70);
                opacity: 0.7;
            }
        </style>

        <div id="page-content">

            <div id="query_form">
                <form class="form-horizontal">

                    <div class="col-xs-12" >
                        <div class="col-xs-3" >
                            <div class="form-group">
                                <label class="col-xs-4 control-label"
                                       style="text-align: right"><@spring.message "hpms.mdm.project.companyName"/></label>
                                <div class="col-xs-7">
                                    <input id="companyId" name="companyId" type="text" data-bind="value:model.companyId" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-3" >
                            <div class="form-group">
                                <label class="col-xs-4 control-label"
                                       style="text-align: right"><@spring.message "hpms.mdm.project.projectName"/></label>
                                <div class="col-xs-7">
                                    <input id="projectId" name="projectId" type="text" data-bind="value:model.projectId" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-3" >
                            <div class="form-group">
                                <label class="col-xs-4 control-label"
                                       style="text-align: right"><@spring.message "hpms.mdm.fee.equipmenttype"/></label>
                                <div class="col-xs-7">
                                    <input id="equipmentTypeId" name="equipmentTypeId" type="text" data-bind="value:model.equipmentTypeId" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-3" >
                            <div class="form-group">
                                <label class="col-xs-4 control-label"
                                       style="text-align: right"><@spring.message "hpms.mdm.property.propertyname"/></label>
                                <div class="col-xs-7">
                                    <span id="versionLov" class="k-widget k-lov k-header" style="width: 92%";>
					                   <span id="hoverLov" tabindex="-1" unselectable="on" class="k-dropdown-wrap k-state-default">
					                   <input id="structureName" data-bind="value:model.structureName" class="k-input" type="text" autocomplete="off" title="" role="lov" aria-expanded="false"  readonly="readonly" style="width: 100%;">
					                   <span id="clearPosition" unselectable="on" onclick="clearVersion()" class="k-icon k-i-close" title="clear" role="button" tabindex="-1">
					               </span>
					               <span id="selectPosition" unselectable="on" class="k-select" aria-label="select" role="button" tabindex="-1" onclick="newTree()">
						             <span class="k-icon k-i-search">
                                     </span>
					               </span>
					              </span>
					            </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-12" >
                        <div class="col-xs-3" >
                            <div class="form-group">
                                <label class="col-xs-4 control-label"
                                       style="text-align: right"><@spring.message "hpms.fin.pubmeter.year"/></label>
                                <div class="col-xs-7">
                                    <input id="year" name="year" type="text" data-bind="value:model.year"  style="width: 100%;">
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-3" >
                            <div class="form-group">
                                <label class="col-xs-4 control-label"
                                       style="text-align: right"><@spring.message "hpms.fin.pubmeter.month"/></label>
                                <div class="col-xs-7">
                                    <input id="month" name="month" type="text" data-bind="value:model.month" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <script>kendo.bind($('#query_form'), viewModel);</script>
            <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                <span type="submit" class="btn btn-primary" style="float:left;width:70px;margin-right:5px;" data-bind="click:queryResource" ><i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
                <span onclick="submitMeter()" class="btn btn-primary" style="float:left;margin-right:10px;"><i class="fa fa-exchange" style="margin-right:3px;"></i><@spring.message "hpms.fin.pubmeter.turnintobilling"/></span>
            </div>
            <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
            <div style="clear:both">
                <div id="Grid"></div>
            </div>

        </div>

        <div id="property_tree" style="display: none"></div>

        <div id="exams">
            <div id="progressBar"></div>
        </div>



        <script type="text/javascript">

            $('#page-content').keydown(function (e) {
                if (e.keyCode == 13) {
                    e.target.blur();
                    viewModel.queryResource(e);
                }
            });

            var pb = $("#progressBar").kendoProgressBar({
                min : 0,
                max : 100,
                type : "value",
                animation : {
                    duration : 400
                }
            }).data("kendoProgressBar");


            function newTree(){

                if(viewModel.model.companyId==''||viewModel.model.companyId==null||viewModel.model.companyId==undefined||
                        viewModel.model.projectId==null||viewModel.model.projectId==undefined||viewModel.model.projectId==''){
                    kendo.ui.showInfoDialog({
                        message:'<@spring.message "hpms.mdm.equipment.company"/><@spring.message "hpms.mdm.equipment.project"/>不能为空'
                    });
                }else{

                    $("#property_tree").kendoWindow({
                        actions: ["Close"],
                        title: $l('<@spring.message "hpms.fin.cusmeter.selectRoom"/>'),
                        draggable: true,
                        height: "350px",
                        width: "410px",
                        content: '${base.contextPath}/fin/property_tree.html?companyId='+viewModel.model.companyId+'&projectId='+viewModel.model.projectId,
                        iframe: true,
                        modal: true
                    });
                    var win = $("#property_tree").data("kendoWindow");
                    win.center().open();
                }
            }
            $("#versionLov").mouseover(function(){
                $("#hoverLov").addClass("k-state-hover");
            });

            $("#versionLov").mouseleave(function(){
                $("#hoverLov").removeClass("k-state-hover");
            });

            function  clearVersion() {
                viewModel.model.set("structureId",null);
                viewModel.model.set("structureName",null);
            }

            function submitMeter(){
                var items=dataSource.data();
                //console.log(items);
                $("#exams").show();
                $.ajax({
                    type : "POST",
                    url  : "${base.contextPath}/hpms/fin/meter/read/cusMeter/submit",
                    dataType:"json",
                    contentType:"application/json",
                    data : kendo.stringify(items),
                    success: function(e) {
                        if(e.success){
                            window.parent.kendo.ui.showInfoDialog({
                                message:$l('hap.tip.success')
                            });
                            $('#Grid').data('kendoGrid').dataSource.page(1);
                            $("#exams").hide();
                        }else{
                            $("#exams").hide();
                            window.parent.kendo.ui.showInfoDialog({
                                message:e.message
                            })
                        }
                    }
                });



            }

            $("#companyId").kendoComboBox({
                valuePrimitive: true,
                dataTextField: "companyFullName",
                dataValueField: "companyId",
                dataSource: {
                    transport: {
                        read:function(options) {
                            $.ajax({
                                type   : "POST",
                                url: "${base.contextPath}/mdm/property/companyQuery",
                                data: {},
                                success: function(json) {
                                    options.success(json.rows);
                                }
                            });
                        }
                    }
                }
            });
            $("#projectId").kendoComboBox({
                autoBind: false,
                valuePrimitive: true,
                cascadeFrom: "companyId",
                cascadeFromField: "companyId",
                filter: "contains",
                dataTextField: "projectName",
                dataValueField: "projectId",
                dataSource: {
                    serverFiltering:true,
                    transport: {
                        read: {
                            url:"${base.contextPath}/mdm/property/projectQuery",
                            type : "POST"
                        },
                        contentType : "application/json",
                        parameterMap: function(options, type) {
                            if (type === "read") {
                                var filter = options.filter.filters[0]
                                var map = {};
                                map[filter.field] = filter.value;
                                return map;
                            }
                        }
                    },
                    schema: {
                        data: 'rows'
                    }
                }
            }) ;

            $("#equipmentTypeId").kendoComboBox({
                valuePrimitive: true,
                dataTextField: "typeName",
                dataValueField: "equipmentTypeId",
                dataSource: {
                    transport: {
                        read:function(options) {
                            $.ajax({
                                type   : "POST",
                                url: "${base.contextPath}/hpms/mdm/equipment/queryEquipmentType?typeAttribute="+'CUSTOMER METER',
                                data: {},
                                success: function(json) {
                                    options.success(json.rows);
                                }
                            });
                        }
                    }
                }
            });

            $("#year").kendoComboBox({
                valuePrimitive: true,
                dataTextField: "code",
                dataValueField: "code",
                dataSource: {
                    transport: {
                        read:function(options) {
                            $.ajax({
                                type   : "POST",
                                url: "${base.contextPath}/hpms/fin/meter/read/his/queryYear",
                                data: {},
                                success: function(json) {
                                    options.success(json.rows);
                                }
                            });
                        }
                    }
                }
            });

            $("#month").kendoComboBox({
                valuePrimitive: true,
                dataTextField: "code",
                dataValueField: "code",
                dataSource: {
                    transport: {
                        read:function(options) {
                            $.ajax({
                                type   : "POST",
                                url: "${base.contextPath}/hpms/fin/meter/read/his/queryMonth",
                                data: {},
                                success: function(json) {
                                    options.success(json.rows);
                                }
                            });
                        }
                    }
                }
            });


            var BaseUrl = _basePath;
            dataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: BaseUrl + "/hpms/fin/meter/read/cus/query",
                        type: "POST",
                        dataType: "json"
                    },
                    parameterMap: function (options, type) {
                        if (type !== "read" && options.models) {
                            var datas = Hap.prepareSubmitParameter(options, type)
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                pageSize: 10,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "equipmentId",
                        fields: {
                            readDate: {type: "date"}
                        }
                    }
                }
            });

            var grid = $("#Grid").kendoGrid({
                dataSource: dataSource,
                height: '100%',
                resizable: true,
                scrollable: true,
                navigatable: false,
                //selectable: 'single, rowbox',
                pageable: {
                    pageSizes: [5, 10, 20, 50],
                    refresh: true,
                    buttonCount: 5
                },
                columns: [
                    {
                        field: "companyFullName",
                        title: '<@spring.message "hpms.mdm.project.companyName"/>',
                        width: 150
                    },
                    {
                        field: "projectName",
                        title: '<@spring.message "hpms.mdm.project.projectName"/>',
                        width: 150
                    },
                    {
                        field: "equipmentName",
                        title: '<@spring.message "hpms.fin.pubmeter.metername"/>',
                        width: 150
                    },
                    {
                        field: "propertyName",
                        title: '<@spring.message "hpms.mdm.property.propertyname"/>',
                        width: 150
                    },
                    {
                        field: "readDate",
                        title: '<@spring.message "hpms.fin.pubmeter.readDate"/>',
                        width: 100,
                        format: "{0:yyyy-MM-dd}"
                    },
                    {
                        field: "invoiceCode",
                        title: '<@spring.message "hpms.fin.pubmeter.invoiceCode"/>',
                        width: 100
                    },
                    {
                        field: "lastRead",
                        title: '<@spring.message "hpms.fin.pubmeter.lastRead"/>',
                        width: 100
                    },
                    {
                        field: "currentRead",
                        title: '<@spring.message "hpms.fin.pubmeter.currentRead"/>',
                        width: 100
                    },
                    {
                        field: "meterTotalUse",
                        title: '<@spring.message "hpms.fin.pubmeter.meterTotalUse"/>',
                        width: 100
                    },
                    {
                        field: "meterTotalAmount",
                        title: '<@spring.message "hpms.fin.pubmeter.meterTotalAmount"/>',
                        width: 100
                    },
                    {
                        field: "statusDesc",
                        title: '<@spring.message "hpms.fin.pubmeter.statusDesc"/>',
                        width: 100
                    },
                ],
                editable: false
            }).data("kendoGrid");

            Hap.autoResizeGrid("#Grid");


        </script>
        </body>
        </html>