<#--
        * description: 仓库管理页面
        * version: 1.0
        * author: jun.guo@hand-china.com
        * #{copyright}#
        *
        -->

    <#include "../include/header.html">
        <script src="${base.contextPath}/common/code?storeHouseType=HPMS_STORE_HOUSE_TYPE" type="text/javascript"></script>


        <script
                src="${base.contextPath}/common/code?enableFlagData=MDM.ENABLE_FLAG">
        </script>

        <style type="text/css">
            span.red {
                color: red;
                font-weight: bold;
            }
        </style>

        <script type="text/javascript">
            var viewModel = kendo.observable({
                model: {},
                createFunction: function () {
                    $('#Grid').data('kendoGrid').addRow();
                },
                saveFunction: function () {
                    $('#Grid').data('kendoGrid').saveChanges();
                },
                queryResource: function (e) {
                    $('#Grid').data('kendoGrid').dataSource.page(1);
                }
            });

            // 临时 id ，用于判断唯一性
            var storeHouseIdTemp = 0;
        </script>
        <body>
        <div id="page-content">
            <div class="panel" style="padding: 0px;border:none;box-shadow: none;width: 80%;">
                <div class="form-horizontal" id="query-form">
                    <div class="panel-body">
                        <div class="row" style="margin-bottom: 5px;">
                            <!-- 公司 -->
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.property.company"/></label>
                                    <div class="col-sm-8">
                                        <input type="text" id="companyId" style="width: 100%"
                                               data-bind="value:model.companyId">
                                        <script>


                                            $("#companyId").kendoDropDownList({
                                                optionLabel: '---请选择---',
                                                dataTextField:"companyFullName",
                                                dataValueField:"companyId",
                                                valuePrimitive:true,
                                                dataSource: {
                                                    transport: {
                                                        read: {
                                                            url:"/fnd/company/query",
                                                            type : "POST"
                                                        },
                                                        contentType : "application/json"
                                                    },
                                                    schema: {
                                                        data: 'rows'
                                                    }
                                                }
                                            });
                                        </script>
                                    </div>
                                </div>
                            </div>

                            <!-- 项目 -->
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.property.project"/></label>
                                    <div class="col-sm-8">
                                        <input type="text" id="projectId" style="width: 100%"
                                               data-bind="value:model.projectId">
                                    </div>
                                    <script>
                                        $("#projectId").kendoDropDownList({
                                            optionLabel: '---请选择---',
                                            dataTextField:"projectName",
                                            dataValueField:"projectId",
                                            cascadeFrom:"companyId",
                                            valuePrimitive:true,
                                            dataSource: {
                                                transport: {
                                                    read: {
                                                        url:"/hpms/mdm/project/query",
                                                        type : "POST"
                                                    },
                                                    contentType : "application/json",
                                                    parameterMap: function(options, type) {
                                                        if (type === "read") {
                                                            return {startDateActive:new Date(),endDateActive:new Date()};
                                                        }
                                                    }
                                                },
                                                schema: {
                                                    data: 'rows'
                                                }
                                            },

                                        });
                                    </script>

                                </div>
                            </div>


                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.storehouse.storehousecode"/></label>
                                    <div class="col-sm-8">
                                        <input type="text" id="storeHouseCode" style="width: 100%"
                                               data-bind="value:model.storeHouseCode" class="k-textbox">
                                    </div>

                                </div>
                            </div>


                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hpms.mdm.storehouse.storehousename"/></label>
                                    <div class="col-sm-8">
                                        <input type="text" id="storeHouseName" style="width: 100%"
                                               data-bind="value:model.storeHouseName" class="k-textbox">
                                    </div>

                                </div>
                            </div>


                        </div>
                </div>
            </div>

            <div class="pull-left" id="toolbar-btn" style="margin-bottom: 10px;">
                        <span class="btn btn-primary k-grid-add"
                              style="float: left; margin-right: 5px;" data-bind="click:createFunction">
                            <i class="fa fa-plus-square" style="margin-right:3px;"></i>
                            <@spring.message "hap.new"/>
                        </span>
                <span class="btn btn-primary k-grid-save-changes"
                      style="float: left; margin-right: 5px;" data-bind="click:queryResource">
                            <i class="fa fa-search" style="margin-right:3px;"></i>
                            <@spring.message "hap.query"/>
                        </span>
            </div>

                <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
                <script>kendo.bind($('#query-form'), viewModel);</script>
        </div>


            <div style="clear:both">
                <div id="Grid"></div>
            </div>
</div>

        <script type="text/javascript">

            $('#query-form input').keydown(function (e) {
                if (e.keyCode == 13) {
                    e.target.blur();
                    viewModel.queryResource(e);
                }
            });

            var BaseUrl = "${base.contextPath}/hpms/mdm/store/house";
            dataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: BaseUrl + "/queryAll",
                        type: "POST",
                        dataType: "json"
                    },
                    update: {
                        url: BaseUrl + "/submit",
                        type: "POST",
                        contentType: "application/json"
                    },
                    destroy: {
                        url: BaseUrl + "/remove",
                        type: "POST",
                        contentType: "application/json"
                    },
                    create: {
                        url: BaseUrl + "/submit",
                        type: "POST",
                        contentType: "application/json"
                    },
                    parameterMap: function (options, type) {
                        if (type !== "read" && options.models) {
                            var datas = Hap.prepareSubmitParameter(options, type)
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                pageSize: 10,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "storeHouseId",
                        fields: {

                            storeHouseCode:{
                                type:"string",
                                validation: {
                                    required: true,
                                    storeHouseCodeValidation: function (input) {
                                        if (input.is("[name='storeHouseCode']") && input.val() != "") {

                                            // 正则校验-只允许输入大写字母、下划线及数字
                                            if (! /^[A-Z0-9_]+$/.test(input.val()) ){
                                                input.attr("data-storeHouseCodeValidation-msg", "<@spring.message 'hpms.mdm.feetype.codelimit'/>");
                                                return false;
                                            }

                                            // ajax 校验唯一
                                            var flag = true;
                                            $.ajax({
                                                type:"POST",
                                                url:"${base.contextPath}/hpms/mdm/store/house/query",
                                                async:false,
                                                dataType:"json",
                                                data:{storeHouseCode:input.val()},
                                                success:function (data) {
                                                    if (data.total!=0 && data.rows[0].storeHouseId != storeHouseIdTemp) {
                                                        input.attr("data-storeHouseCodeValidation-msg","<@spring.message 'hpms.mdm.feetype.unique'/>");
                                                        flag = false;
                                                    }
                                                }

                                            });
                                            return flag;
                                        }
                                        return true;
                                    }
                                }
                            },
                            enableFlag:{defaultValue: 'Y',type: 'boolean',checkedValue:'Y',uncheckedValue:'N'}
                        }
                    }
                }
            });
            var companyData = [];
            var projectData = [];

            $("#Grid").kendoGrid({
                dataSource: dataSource,
                height: '100%',
                resizable: true,
                scrollable: true,
                navigatable: false,
                pageable: {
                    pageSizes: [5, 10, 20, 50],
                    refresh: true,
                    buttonCount: 5
                },
                editable: "inline",
                columns: [

                    {
                        title: '<@spring.message "hpms.mdm.feetype.operation"/>',
                        command: [
                            {name:"edit"}
                        ],
                        attributes: {style: "text-align:center"},
                        width: 60
                    },
                    {
                        field: "companyId",
                        title: '<@spring.message "hpms.mdm.property.company"/>',
                        width: 120,
                        template: function(dataItem){
                            return dataItem['companyFullName']|| ''
                        },
                        editor: function(container, options) {
                            if (options.model.storeHouseId == "") {

                                $.ajax({
                                    url: '${base.contextPath}/mdm/property/companyQuery',
                                    type: 'POST',
                                    contentType: "application/json;charset=utf-8",
                                    cache: false,
                                    dataType: 'json',
                                    async: false,
                                    success: function (data) {
                                        companyData = data.rows
                                    }
                                });
                                $('<input required style="width: 95%;" ' + 'validationMessage="<@spring.message "hap.error.nullexception"/>"' + 'name="' + options.field + '"/>')
                                        .appendTo(container)
                                        .kendoDropDownList({

                                            dataTextField: "companyFullName",
                                            dataValueField: "companyId",
                                            valuePrimitive: true,
                                            dataSource: companyData,
                                            select: function (e) {
                                                options.model.set('projectName', null);
                                                options.model.set('projectId', null);
                                                options.model.set('companyFullName', e.sender.dataItem(e.item)[e.sender.options.dataTextField]);
                                                $.ajax({
                                                    url: '${base.contextPath}/mdm/property/projectQuery?companyId=' + options.model.companyId,
                                                    type: 'POST',
                                                    contentType: "application/json;charset=utf-8",
                                                    cache: false,
                                                    dataType: 'json',
                                                    async: false,
                                                    success: function (data) {
                                                        var dropdownlist = $("#projectId2").data("kendoDropDownList");
                                                        dropdownlist.setDataSource(data.rows);
                                                    }
                                                });
                                            }
                                        });
                                $('<span class="red">*</span>').appendTo(container);
                            }else{
                                container.html(options.model.companyFullName);
                                container.removeClass('k-edit-cell');
                            }

                        }

                    },
                    {
                        field: "projectId",
                        title: '<@spring.message "hpms.mdm.property.project"/>',
                        width: 120,
                        template: function(dataItem){
                            return dataItem['projectName']|| ''
                        },
                        editor: function(container, options) {
                            if (options.model.storeHouseId == "") {
                                console.log(options.model.companyId);
                                $.ajax({
                                    url: '${base.contextPath}/mdm/property/projectQuery?companyId=' + options.model.companyId,
                                    type: 'POST',
                                    contentType: "application/json;charset=utf-8",
                                    cache: false,
                                    dataType: 'json',
                                    async: false,
                                    success: function (data) {
                                        projectData = data.rows;
                                    }
                                });
                                $('<input  required style="width: 95%;" id="projectId2" ' + 'validationMessage="<@spring.message "hap.error.nullexception"/>" ' + ' name="' + options.field + '"/>')
                                        .appendTo(container)
                                        .kendoDropDownList({

                                            dataTextField: "projectName",
                                            dataValueField: "projectId",
                                            valuePrimitive: true,
                                            dataSource: projectData,
                                            select: function (e) {
                                                options.model.set('projectName', e.sender.dataItem(e.item)[e.sender.options.dataTextField]);
                                            }
                                        });
                                $('<span class="red">*</span>').appendTo(container);
                            }else{
                                container.html(options.model.projectName);
                                container.removeClass('k-edit-cell');
                            }
                        }

                    },
                    {
                        field: "storeHouseCode",
                        title: '<@spring.message "hpms.mdm.storehouse.storehousecode"/>',
                        attributes: {style: "text-align:center"},
                        width: 100,
                        editor:function (container, options) {
                            if(options.model.storeHouseId==""){
                                $('<input required style="width: 90%;" ' +
                                        'class="k-input k-textbox" validationMessage="<@spring.message "hap.error.nullexception"/>" ' +
                                        'name="' + options.field + '"/>' +
                                        '<span class="red">*</span>')
                                        .appendTo(container);
                            }else{
                                container.html(options.model.storeHouseCode);
                                container.removeClass('k-edit-cell');
                            }

                        }
                    },
                    {
                        field: "storeHouseName",
                        title: '<@spring.message "hpms.mdm.storehouse.storehousename"/>',
                        attributes: {style: "text-align:center;white-space:nowrap;height: 25px"},
                        width: 100,
                        editor:function (container, options) {
                            if(options.model.storeHouseId==""){
                                $('<input required style="width: 90%;" ' +
                                        'class="k-input k-textbox" validationMessage="<@spring.message "hap.error.nullexception"/>" ' +
                                        'name="' + options.field + '"/>' +
                                        '<span class="red">*</span>')
                                        .appendTo(container);
                            }else{
                                container.html(options.model.storeHouseName);
                                container.removeClass('k-edit-cell');
                            }

                        }
                    },
                    {
                        field: "type",
                        title: '<@spring.message "hpms.mdm.storehouse.storehousetype"/>',
                        attributes: {style: "text-align:center"},
                        width: 100,
                        template: function(dataItem){
                            return dataItem['meaning']|| ''
                        },
                        editor: function(container, options){
                            if(options.model.storeHouseId==""){
                                $('<input style="width: 90%;" required validationMessage="<@spring.message "hap.error.nullexception"/>" name="' + options.field + '"/>')
                                        .appendTo(container)
                                        .kendoDropDownList({
                                            dataTextField: "meaning",
                                            dataValueField: "value",
                                            valuePrimitive: true,
                                            dataSource: storeHouseType,
                                            template: function(dataItem){
                                                return dataItem['meaning'] || ''
                                            },
                                            select : function(e){
                                                var dataItem = this.dataItem(e.item);
                                                options.model.set('type',dataItem.value);
                                                options.model.set('meaning',dataItem.meaning);
                                            }
                                        });
                                $('<span class="red">*</span>').appendTo(container);
                            }else{
                                container.html(options.model.meaning);
                                container.removeClass('k-edit-cell');
                            }

                        }

                    },
                    {
                        field: "address",
                        title: '<@spring.message "hpms.mdm.storehouse.storehouseaddress"/>',
                        attributes: {style: "text-align:center;white-space:nowrap;height: 25px"},
                        width: 150,
                        editor:function (container, options) {
                            $('<input style="width: 100%;" class="k-input k-textbox" name="' + options.field + '"/>')
                                    .appendTo(container);
                        }
                    },
                    {
                        field: "enableFlag",
                        title: '<@spring.message "hpms.mdm.feetype.enableflag"/>',
                        attributes: {style: "text-align:center"},
                        width: 40
                    }
                ],
                edit: function (e) {
                    storeHouseIdTemp = e.model.storeHouseId || 0;
                }
            });

            function deleteData() {

                Hap.deleteGridSelection({
                    grid: $('#Grid')
                });

            }

            Hap.autoResizeGrid("#Grid");
            $("#Grid thead>tr th").css("text-align","center");

        </script>
        </body>
        </html>