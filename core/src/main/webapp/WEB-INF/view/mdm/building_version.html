<#--
        * description: 建筑版本界面
        * author:fuchun.hu@hand-china.com
        * version: 1.0
        *
        -->
    <#include "../include/header.html">
  <body>
  <style>
      span[class='k-window-title'] {
          user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          -webkit-user-select: none;
          -webkit-touch-callout: none;
      }

      span[class^="l-icon-"] {
          width: 20px;
          height: 16px;
          overflow: hidden;
          display: inline-block;
      }



  </style>

  <script type="text/javascript">
      var viewModel = kendo.observable({
          model:{},

          //查询
          queryResource: function(e) {
              $('#grid').data('kendoGrid').dataSource.page(1);
          },

          //重置
          resetForm : function(e) {
              var formData = viewModel.model.toJSON();
              for ( var k in formData) {
                  viewModel.model.set(k, null);
              }
          },

          //新建
          createFunction: function(){
              $('#grid').data('kendoGrid').addRow();
          },


      });

  </script>

  <!--********************我是查询字段分割线*******************************-->
  <div id="page-content">
      <div class="panel" style="padding: 0px;border:none;box-shadow: none;">
          <form class="form-horizontal" id="query-form" style="margin-top: 1px;">
              <div class="panel-body">

                  <div class="row" style="margin-bottom: 5px;">
                      <!-- 公司 -->
                      <div class="col-sm-4">
                          <div class="form-group">
                              <label class="col-sm-4 control-label">公司</label>
                              <div class="col-sm-8">
                                  <input type="text" id="companyId" style="width: 160px"
                                         data-bind="value:model.companyId"
                                         class="k-textbox">
                              </div>
                          </div>
                      </div>

                      <!-- 项目 -->
                      <div class="col-sm-4">
                          <div class="form-group">
                              <label class="col-sm-4 control-label">项目</label>
                              <div class="col-sm-8">
                                  <input type="text" id="projectId" style="width: 160px"
                                         data-bind="value:model.projectId"
                                         class="k-textbox">
                              </div>
                          </div>
                      </div>


                      <div >
                          <span class="btn btn-primary" data-bind="click:queryResource" style="width: 70px;float:left;margin-right:5px;" type="submit">查询</span>
                          <span class="btn btn-default" style="float:left;width:70px"  data-bind="click:resetForm" type="button">重置</span>
                      </div>
                      <div style="clear:both"></div>
                  </div>
          </form>
      </div>
      <!--将form和viewmodel进行绑定-->
      <script>kendo.bind($('#query-form'), viewModel);</script>


      <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;margin-left:15px;">
          <span class="btn btn-primary" style="margin-left:15px;" data-bind="click:createFunction">新建</span>
      </div>
      <!--将按钮绑定到viewmodel上-->
      <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
      <div style="clear: both;">
          <div id="grid"></div>
      </div>
  </div>


  <!--**************我是grid分割线*****************-->
  <script>
      function addStudent(){
          $('#grid').data('kendoGrid').addRow();
      }

      function saveStudent(){
          $('#grid').data('kendoGrid').saveChanges();
      }

      function clearStudent(){
          $('#grid').data('kendoGrid').cancelChanges();
      }

      function editBuildingVersion(versionId,versionNumber){
          //打开新的tab页
          parent.openTab('VersionDetail'+versionId,versionNumber,'mdm/version_structure.html?versionId='+versionId);

      }


      var crudServiceBaseUrl = "${base.contextPath}/mdm/BuildingVersion",
              dataSource = new kendo.data.DataSource({
                  transport: {
                      read:  {
                          url: crudServiceBaseUrl + "/query",
                          type : "POST",
                          dataType: "json"
                      },
                      create : {
                          url : crudServiceBaseUrl + "/submit",
                          contentType: "application/json",
                          type : "POST",

                      },
                      update : {
                          url : crudServiceBaseUrl + "/submit",
                          contentType: "application/json",
                          type : "POST",
                      },
                      destroy: {
                          url: crudServiceBaseUrl + "/remove",
                          contentType: "application/json",
                          type: "POST"
                      },
                      parameterMap: function(options, type) {
                          if (type !== "read" && options.models) {
                              //判断状态
                              var datas = Hap.prepareSubmitParameter(options, type);
                              //从一个对象解析出字符串
                              return kendo.stringify(datas);
                          } else if (type === "read") {
                              return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                          }
                      }
                  },
                  batch: true,
                  serverPaging : true,//是否在服务器端分页
                  pageSize: 10,
                  schema: {
                      data:'rows',
                      total:'total',
                      model: {
                          id: "versionId",   //标记信息状态的属性，不然没法根据状态判断是add还是update
                          fields: {
                              //默认版本
                              defaultVersion:{defaultValue: 'N',type: 'boolean',checkedValue:'Y',uncheckedValue:'N'},




                          }

                      }
                  }
              });


      var grid = $("#grid").kendoGrid({
          dataSource: dataSource,
          navigatable: false,
          height: '100%',
          resizable: true,
          scrollable: true,
          reorderable:true,
          columnMenu: true,
          selectable:'row',
          pageable: {
              pageSizes: [5, 10, 20, 50],
              refresh: true,
              buttonCount: 5
          },
          columns: [
              {
                  field: "versionNumber",
                  title: '编码',
                  width: '17%' ,
                  attributes: {style: "text-align:center"},
                  template : function (rowdata) {
                      if (!!rowdata.versionId) {
                          return '<a style="text-decoration : underline;color : blue;cursor:pointer" onclick="editBuildingVersion('+rowdata.versionId+',\''+rowdata.versionNumber+'\')"><font color="blue">'
                                  + rowdata.versionNumber
                                  + '</font></a>';

                      }else return rowdata.versionNumber
                  },
                  editor: function (container, options) {
                      //alert(options.field);
                      $('<input type="text" validationMessage="只允许输入大写字母、数字及下划线"  name="' + options.field + '" pattern="^[0-9A-Z_]+$" />').appendTo(container).kendoMaskedTextBox({});

                  },

              },
              {
                  field: "companyId",
                  title: '所属公司',
                  width: '18%' ,
                  attributes: {style: "text-align:center"},

              },
              {
                  field: "projectId",
                  title: '项目',
                  width: '18%' ,
                  attributes: {style: "text-align:center"},

              },
              {
                  field: "versionName",
                  title: '版本名称',
                  width: '17%' ,
                  attributes: {style: "text-align:center"},
              },
              {
                  field: "versionDescription",
                  //name:"meaning",
                  title: '版本描述',
                  width: '20%' ,
                  attributes: {style: "text-align:center"},


              },
              {field: "defaultVersion",
                  width: '8%',
                  title: '默认版本',
                  attributes: {style: "text-align:center"}
              },

              {

                  command	: [{
                      name : "edit",
                      text :'编辑'

                  },
                      {
                          name:'destroy',
                          text:'删除'
                      }],
                  title		: "操作",
                  width		: "16%" ,
                  headerAttributes: {
                      style: "text-align: center"
                  },

              },
          ],
          editable: "inline"

      }).data("kendoGrid");


      //自动调整
      Hap.autoResizeGrid("#grid");
      //设置表格上的字居中
      $("#grid thead>tr th").css("text-align","center");

  </script>

</body>
