<#-- * description: 客户档案主页面 * version: 1.0 *
author:huifang.zhou@hand-china.com * --> <#include
"../include/header.html">
<html>
<body>
<script
	src="${base.contextPath}/common/code?customerType=HPMS_MDM_CUSTOMER_TYPE"
	type="text/javascript"></script>
	<script type="text/javascript">
    var viewModel = kendo.observable({
        model: {},
        createFunction: function () {
            $('#Grid').data('kendoGrid').addRow();
        },
        saveFunction: function () {
            newViewModel.model.__status = 'add';
            Hap.submitForm({
                url: '${base.contextPath}/hpms/mdm/BpGeneral/submit',
                formModel: viewModel.model,
                success: function (data) {
                    $.each(viewModelPersonage.model.toJSON(), function (i, item) {
                        viewModelPersonage.model.set(i, null);
                    });
                    $("#newDialog").data("kendoWindow").close();
                    $('#Grid').data('kendoGrid').dataSource.query();
                }
            });
        },
        queryResource: function (e) {
            $('#grid').data('kendoGrid').dataSource.page(1);
        }
    });
</script>
	<div id="viewDialog" style="display: none"></div>
	<div id="newDialog" style="display: none"></div>
	<div id="page-content">
		<div class="pull-left" id="toolbar-btn" style="padding-bottom: 10px;">
			<span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" onclick="NewDialog()">
	          <i class="fa fa-plus-square" style="margin-right:3px;"></i>
	           <@spring.message "hap.new"/>
               </span>
		</div>
		<script>kendo.bind($('#toolbar-btn'), viewModel);</script>
		<div class="pull-right" id="query-form" style="padding-bottom: 10px;">
			<input id="dropDownList" style="width: 150px; float: left; margin-right: 5px;" data-bind="value:model.selectCombox"/> 
			<input data-role="maskedtextbox" type="text" style="width: 150px; float: left; margin-right: 5px;" data-bind="value:model.value" class="k-textbox"/>
				<span class="btn btn-primary k-grid-save-changes" style="float: left; margin-right: 5px;" data-bind="click:queryResource">
             <i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
			<div style="clear: both"></div>
		</div>
		<script>kendo.bind($('#query-form'), viewModel);</script>
		<div style="clear: both;">
			<div id="grid"></div>
		</div>
	</div>

	<script type="text/javascript">
$(function () {
        var data = [
            { text: "--请选择--", value: "0" },
            { text: "客户编号", value: "客户编号" },
            { text: "客户名称", value: "客户名称" },
            { text: "手机号", value: "手机号" },
            { text: "证件号码", value: "证件号码" }
        ];

        $("#dropDownList").kendoDropDownList({
            dataTextField: "text",
            dataValueField: "value",
            dataSource: data,
            valuePrimitive: true,
            index: 0 // 当前默认选中项，索引从0开始。
        });
    });

	$('#query-form input').keydown(function (e) {
	    if (e.keyCode == 13) {
	        e.target.blur();
	        viewModel.queryResource(e);
	    }
	});

function NewDialog() {
        $("#newDialog").kendoWindow({
            actions: ["Close"],
            title: $l('<@spring.message "hap.new"/>'),
            draggable: true,
            height: "450px",
            width: "650px",
            close: function(){
                $("#newDialog").empty();
            },
            content: "${base.contextPath}/mdm/customer_archives_edit.html?isedit=0",
            iframe: true,
            modal: true
        });
        var win = $("#newDialog").data("kendoWindow");
        win.center().open();
    }
    
    
    
    
  
    var crudServiceBaseUrl = '${base.contextPath}'
    dataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: crudServiceBaseUrl + "/hpms/mdm/Customer/queryByColumnName",
                        type    : "POST",
                        dataType: "json"
                    },
                    parameterMap: function (options, type) {
                        if (type !== "read" && options.models) {
                            var datas = Hap.prepareSubmitParameter(options, type);
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                        }
                    }
                },
                requestEnd : function(e) {
						if (e.type != "read") {
							dataSource.page(dataSource._page);
						}
					},
                batch: true,
                serverPaging: true,
                pageSize: 10,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "customerId",
                        fields: {
                        	meaning1:{type:"string"},
                        	meaning:{type:"string"},
                        	customerName:{type:"string"},
                        	enableFlag: {defaultValue: 'Y',type: 'boolean',checkedValue:'Y',uncheckedValue:'N'}
                        }
                    }
                }
            });
    var grid = $("#grid").kendoGrid({
        dataSource: dataSource,
        navigatable: false,
        height: '100%',
        resizable: true,
        scrollable: true,
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field      : "",
                title      : '<@spring.message "hap.action"/>',
                width      : 120 ,
                attributes  : {style: "text-align:center"},
                template : function(rowdata) {
                    var uid = rowdata.uid.toString();
                    var singleDispatch = '<button type="button" id="lookFee" class="btn btn-success btn-xs" data-toggle="tooltip" data-placement="top" title='+'<@spring.message "hap.view"/>'+' onclick="lookCustomer('+rowdata.customerId+',\''+ rowdata.bpId+'\',\''+ rowdata.enableFlag+ '\')"><span class="glyphicon glyphicon-search"></span></button>&nbsp;';
                    var singleRecycle;
                    if (rowdata.enableFlag == "Y") {
						singleRecycle = '<button type="button" id="recycle" class="btn btn-default btn-xs" data-toggle="tooltip" data-placement="top" title='+'<@spring.message "hap.failure"/>'+' onclick="failureCustomer('+rowdata.customerId+')"><span class="glyphicon glyphicon-remove"></span></button>';
					}else if(rowdata.enableFlag == "N"){
						singleRecycle = '<button type="button" id="recycle" class="btn btn-default btn-xs" data-toggle="tooltip" data-placement="top" title='+'<@spring.message "hap.failure"/>'+' onclick="startCustomer('+rowdata.customerId+')"><span class="glyphicon glyphicon-ok"></span></button>';
					}
                   		return singleDispatch + singleRecycle;
                }
            },
            {
            
                field: "customerNumber",
                title: '<@spring.message "hpms.mdm.customer.customernumber"/>',
                width: 120
            },
            {
                field: "customerName",
                title: '<@spring.message "hpms.mdm.bpGeneral.fullname"/>',
                width: 130
            },
            {
                field: "meaning1",
                title: '<@spring.message "hpms.mdm.customer.customertype"/>',
                width: 120
            },
            {
                field: "contactMobile",
                title: '<@spring.message "hpms.mdm.bpGeneral.contactmobile"/>',
                width: 120
            },
            {
                field: "meaning",
                title: '<@spring.message "hpms.mdm.bpGeneral.credentialtype"/>',
                attributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "credentialNumber",
                title: '<@spring.message "hpms.mdm.bpGeneral.credentialnumber"/>',
                attributes: {style: "text-align:center"},
                width: 150
            },{
                field: "enableFlag",
                title: '<@spring.message "hpms.mdm.Fee.enableFlag"/>',
                width: 80,
                attributes: {style: "text-align:center"}

            }
        ]
    }).data("kendoGrid");
 	 //点击失效,修改记录状态
 	 function failureCustomer(customerId){
 	 	$.ajax({ 
 	 		url: "${base.contextPath}/hpms/mdm/Customer/updateByEnableFlag?customerId="+customerId,
    							type:"POST",
    							dataType:"json",
    							contentType:"application/json",
    				 			success: function(data){
											if (data.success) {
												kendo.ui.showInfoDialog({
													message : '<@spring.message "hap.tip.success"/>'
												});
											dataSource.page(dataSource._page);
											}else{
											     kendo.ui.showInfoDialog({
													message : data.message
												});
											}
      						}});
 	 }
 	 
 	 
 	 
 	 function startCustomer(customerId){
 	 	$.ajax({ 
 	 		url: "${base.contextPath}/hpms/mdm/Customer/updateByEnableFlag?customerId="+customerId,
    							type:"POST",
    							dataType:"json",
    							contentType:"application/json",
    				 			success: function(data){
											if (data.success) {
												kendo.ui.showInfoDialog({
													message : '<@spring.message "hap.tip.success"/>'
												});
											dataSource.page(dataSource._page);
											}else{
											     kendo.ui.showInfoDialog({
													message : data.message
												});
											}
      						}});
 	 }
     function lookCustomer(customerId,bpId,enableFlag) {
        $("#viewDialog").kendoWindow({
            actions: ["Close"],
            title: $l('<@spring.message "hap.view"/>'),
            draggable: true,
            height: "450px",
            width: "650px",
            close: function(){
               $("#newDialog").empty();
            },
            content: "${base.contextPath}/mdm/customer_archives_edit.html?islook=1&customerId="+customerId+"&bpId="+bpId+"&enableFlag="+enableFlag,
            iframe: true,
            modal: true
        });
        console.log(bpId)
        var win = $("#viewDialog").data("kendoWindow");
        win.center().open();
    }
    //自动根据当前屏幕大小调整表格
    Hap.autoResizeGrid("#grid");
    $("#grid thead>tr th").css("text-align","center");

</script>

</body>
</html>